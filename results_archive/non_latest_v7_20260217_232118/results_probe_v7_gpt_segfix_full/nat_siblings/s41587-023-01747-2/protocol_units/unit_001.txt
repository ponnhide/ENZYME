methods provide Indeed, it is a major goal in systems biology to generate in silico tissue
high-information-content spatial registrations of tissues3. Within devel- models that incorporate increasing complexity, capturing multiple
oping systems, single-cell sequencing and image-based measurements high-resolution length scales and including multiple cellular feature
can be used to reconstruct cell state trajectories, which promise new modalities6,7. A major challenge to achieve this goal is to integrate multiinsights into the differentiation dynamics across lineages and spa- modal measurements across spatial scales in meaningful ways to reveal
tial domains. Applied to human stem cell-derived organoids4,5, these the mechanisms that drive tissue development and morphogenesis.

1
 Department of Biosystems Science and Engineering, ETH Zürich, Basel, Switzerland. 2Institute of Molecular and Clinical Ophthalmology Basel,
Basel, Switzerland. 3Department of Ophthalmology, University of Basel, Basel, Switzerland. 4Department of Molecular Life Sciences,
University of Zurich, Zurich, Switzerland. 5Present address: Institute of Human Biology (IHB), Roche Pharma Research and Early Development,
Roche Innovation Center Basel, Basel, Switzerland. 6These authors contributed equally: Philipp Wahle, Giovanna Brancati, Christoph Harmel, Zhisong He.
 e-mail: lucas.pelkmans@imls.uzh.ch; barbara.treutlein@bsse.ethz.ch; jarrettgrayson.camp@unibas.ch

Article https://doi.org/10.1038/s41587-023-01747-2

a Retinal organoids Cone d Retinal organoid (39 weeks) MTU g MTU 6 i
 Rod Multiplexed tissue 1
 units (MTUs)
 Müller glia 2
 Human Horizontal 3
 iPSCs Timecourse (6–39 weeks) Bipolar 4 150 µm
 Amacrine 5 Outline
 Ganglion
 Adult human 6 EPHB2 ii
 retina 7

b Histological iterative indirect immunofluorescence imaging (Histo4i) 8
 9 i
 Image (×40)
 10
 50 µm
 50 µm 11 ii
 Tissue
 sections
 96-well
 super-
 Stain
 - Acquire 13 14 15 16 17 18 19 20 21 22
 12
 h Segmented nuclei
 21 cycles (39 weeks)
 structure - Denoise 23 24 25 26 27 28 29 30 31 32
 Elute antibodies - Register
 - Pixel cluster e MTUs 1: HCs f MTUs
 Glass coverslip - Segment nuclei 17:Mitochondria
Analyses: 7: MG nuclei Cone
 Rod HC
 Tissue Nuclei Cell Morphology

 UMAP1
 units 10: OLM BC MG
 heterogeneity neighboorhoods trajectories
 9: BC cytoplasm AC RPC
c Millimeter Nanometer UMAP2
 Intermediate

 39 weeks Pixel size 11: ACs
 3: PR cytoplasm
 i HES1
 0.162 µm
 2: PR nuclei
 29: BC nuclei

 23: LW cones
 32: Collagen
 150 µm 25 µm 2 µm
Organoid 25: Plexiform layer PRKCA

j k l m n

 RHO

 High

 50 µm 50 µm 50 µm 50 µm 50 µm
 Adult retina 6 weeks 12 weeks 18 weeks 24 weeks Protein Low
 expression

features of developing retinal organoids and primary human retina. and peripherally located structures such as mitochondria, the OLM, PR cytoplasm
a, 4i was performed on tissues of a timecourse of retinal organoid development and nuclei, long-wave (LW) cones and the plexiform layers (f). g, MTU 6 (top) is
(6, 12, 18, 24 and 39 weeks) and adult retina tissue. Schematic shows retinal cell enriched for EPHB2 protein expression (bottom) and non-uniformly distributed
type organization. b, Schematic of the 4i methodology and analyses. FFPE tissue in the organoid section (outlined by red line). Insets show regions with high (i) and
sections were placed on a 96-well format coverslip that was subsequently attached low (ii) detection of EPHB2 fluorescence immunohistochemical signal. Patterned
to a 96-well superstructure allowing immunohistological treatment, followed EPHB2 staining was observed in all 39-week replicates (11 sections and three
by imaging and antibody elution. Here, we performed 21 immunohistochemical organoids). h, Heterogeneity analysis of nuclei with UMAP projection based on
staining cycles. Images were acquired at ×40 magnification with a high-NA protein features and colored by labels transferred from sequenced cells. All major
silicone oil objective, tiled across the tissue. c, Representative 4i dataset types are identified, including RGCs, HCs, cones, ACs, rods, BCs and MG. i, Feature
image showing overview of a Hoechst stain of a 39-week organoid section and plots highlighting median signal level per nucleus of HES1, identifying nuclei
progressive magnifications from millimeter to nanometer scales. d–f, Example of located in the INL; PRKCA, enriched in BCs; and RHO, identifying cells located in
pixel clustering of a 39-week organoid section. d, Thirty-two global MTUs resolve the ONL. j–n, Primary adult human retina section (j) and retinal organoid sections
the tissue structure with image quality and label biological structures in individual from different timepoints (k–n) with pixels labeled by MTUs derived from
samples. e,f, Biological structures identified by unique MTUs include HCs, BC communal clustering and comparable across samples.

In particular for human development, where embryonic samples are and single-cell transcriptome characterization of developed organoids
scarce, there is the additional challenge to achieve this with organoid have confirmed their high similarity to the primary human retina14,16,17,
models, which often lack stereotypic organization, with substantial providing a foundation for understanding human retina development
heterogeneity within and between organoids. There is, thus, a large and disease in vitro. Retinal organoids develop over the course of
unmet need to implement and integrate multimodal technologies in months, reaching a maximal in vitro maturation state around the age
developmentally dynamic and human-relevant model systems8. of 30 weeks with current methods14. Multiple studies have shown the
 Retinal organoids generated from induced pluripotent stem cells potential value of retinal organoids for modeling human vision dis-
(iPSCs) offer an inroad into studying human retina development, iden- orders18–21. However, differentiation trajectories and morphological
tifying mechanisms of disease and facilitating the discovery of new heterogeneity have yet to be quantitatively evaluated, and a recontreatments9. From the breakthrough discovery that optic cups spon- struction of the gene regulatory networks (GRNs) that underlie diftaneously self-organize in three-dimensional PSC-derived cultures ferentiation of each neuronal and glia cell type within the organoid
in vitro10–12, multiple different protocols to generate human retinal tissues is lacking. More generally, we lack a foundation to integrate
organoids have been developed13–15. Retinal organoids are composed high-resolution and high-information-content imaging data of tissue
of diverse neural cell types: rod and cone photoreceptors (PRs), bipolar organization with sequencing data to assess phenotypes within these
cells (BCs), horizontal cells (HCs), amacrine cells (ACs), retinal gan- complex organoid tissues.
glion cells (RGCs), non-neural Müller glia (MG) and retinal pigment In this study, we established an experimental pipeline for perepithelium (RPE). These cells self-organize into a stereotypical laminar forming iterative indirect immunofluorescence imaging (4i)22 on hisstructure with outer and inner plexiform layers and outer (PR nuclei) tological sections of retinal organoids at high spatial resolution, and
and inner (ACs, BCs and HCs) nuclear layers (ONL and INL), together we developed a computational approach for inferring spatial developwith RGCs in the RGC layer. Remarkably, immunohistochemical analysis mental dynamics from multiplexed protein maps of heterogeneous

Article https://doi.org/10.1038/s41587-023-01747-2

organoids. We combined this with a dense single-cell RNA sequencing 32 MTUs, which we analyze throughout the manuscript. Focusing
(scRNA-seq) and single-cell assay for transposase-accessible chroma- on an exemplary 39-week organoid, these MTUs provide a detailed
tin using sequencing (scATAC-seq) dataset covering 6–46 weeks of characterization of the spatial organization of the tissue (Fig. 1d).
development, which can reconstruct differentiation trajectories into Hierarchical clustering and heat map visualization of average protein
each of the major neuronal and glial lineages. Integration of all data expression within each MTU highlight how each protein stain associmodalities provides a first-of-its-kind digital representation of human ates with each MTU (Supplementary Fig. 4a). We found that the MTU
retinal organoid development. The digital organoid map can be used patterns are similar across different sections from the same organoid
to explore spatial interactions over time and predict gene regulatory as well as between organoids of the same timepoint (Supplementary
modules underlying retinal neurogenesis. We performed follow-up Fig. 4b,c). This indicates that MTUs provide a meaningful approach
‘in organoid’ mosaic perturbations of selected transcription factors to quantify principles of tissue organization and composition in an
(TFs) and focused on the orthodenticle homeobox 2 (OTX2) regulon unbiased manner, which is robust to the morphological heterogenerequired for human retinal neurogenesis23–25. Altogether, we think that ity observed within and between organoids. We observed that certain
our work is a major advance toward a virtual human retinal organoid MTUs distinguish different cell types, whereas others resolve subcelluand our approaches should be adaptable to other developing organoid lar and tissue structures (Fig. 1e,f), illustrating their versatile multiscale
or other model systems. nature. For example, MTU 9 and MTU 29 segment a subset of BC nuclei
 and cytoplasm, respectively; MTU 17 resolves mitochondria; MTU 10
Results highlights the outer limiting membrane (OLM); and MTU 25 labels the
Spatial protein map of human retinal organoids and adult outer and inner plexiform layers. MTU 6 identified a surprising feature
retina marked by ephrin type B receptor 2 (EPHB2) (Fig. 1g). EPHB2 functions
To establish a spatial retinal organoid reference map, we applied 4i in axon guidance and is asymmetrically expressed in retinal neurons
covering a timecourse of human retinal organoid development (6, 12, 18, demarcating dorsal and ventral domains of the developing mammalian
24 and 39 weeks; 2–4 organoids per timepoint; Supplementary Table 1) retina27, suggesting that dorsoventral patterning domains can emerge
as well as an adult primary human retina (Fig. 1a). For each retinal orga- during human retinal organoid development.
noid and the primary adult tissue, we performed multiplexed immu- Focusing on segmented nuclei in an exemplary 39-week organoid
nohistochemistry on 3-μm-thick formalin-fixed, paraffin-embedded section, variance analysis in the protein expression feature space and
(FFPE) sections (1–4 sections per sample; Supplementary Table 1 visualization in a uniform manifold approximation and projection
and Fig. 1b). We generated tiled images at ×40 magnification with a (UMAP) embedding revealed eight molecularly distinct nuclei clusters
high-numerical-aperture (NA) silicone oil objective to cover length (Supplementary Fig. 4d,e), and comparison of protein expression
scales from the millimeter to the nanometer scale (pixel size, 0.1625 μm) with single-cell transcriptomes14 enabled cell type assignment to each
(Fig. 1c). We established a panel of 63 antibodies covering major retinal nuclei cluster (Fig. 1h,i and Supplementary Fig. 4e,f). The major retina
cell types, subcellular compartments, morphological structures and cell types could be identified, including PRs, RGCs, HCs, ACs, BCs and
signaling pathways split into three color channels (Supplementary MG (Fig. 1h). When combining all 39-week organoids into a combined
cycles, with usable data from 53 antibodies and a nuclei stain (Sup- samples (Supplementary Fig. 4g).
plementary Fig. 1a,b). To achieve multiplexing, we aligned images26 Over the timecourse and in the adult primary tissue, we also
across all cycles, allowing simultaneous display of any protein stain observed striking progression of MTU and nuclei organization pat-
(Supplementary Figs. 1c–f and 2a,b). In our experimental design, we terns, further showcasing the robustness of the methods and the
interspersed unstained cycles to subtract cycle-specific backgrounds, scale-crossing richness of the dataset for exploring developmental
permuted antibodies to assess influence of antibody order and per- phenomena (Fig. 1j–n and Supplementary Fig. 3). We provide a web
formed elution controls (Methods). These technical assessments con- application (EyeSee4is, https://eyesee4is.ethz.ch/) to facilitate access
firmed that the staining patterns passing quality control were robust to the imaging data and computed features over the timecourse. Alto-
(Supplementary Fig. 2c–f). Altogether, this resulted in an expression gether, these data establish 4i on tissues as a flexible, robust, sensitive
matrix with over 400 million pixels, registering 53 immunofluorescence and high-dimensional method to describe organoid cell composition
intensity measurements and a Hoechst stain from a retinal organoid and structure based on protein measurements.
developmental timecourse comprising 41 retinal organoid sections
and an adult human retina sample. Spatiotemporal dynamics of retinal layer formation
 For all tissues and timepoints, we established a multiscale analy- To study how the laminar structure in retinal tissue emerges, we
sis pipeline that includes an unsupervised machine-learning-based developed a computational approach to reconstruct organoid lamiclustering of pixels from their 54-plex intensity profile (termed multi- nar structure dynamics from multiplexed imaging data. This method
plexed tissue units (MTUs))22, nuclei segmentation (~330,000 nuclei) (Laminator) establishes a contour around the organoid; segments and
and assessment of nuclei heterogeneity and spatial arrangement from vertically orients adjacent laminar windows circumference-spanning
protein intensities and MTU distributions (Methods). MTUs can be each organoid; quantifies signals across laminar windows; analyzes
generated for single samples or for the entire timecourse (global MTUs; laminar window heterogeneity; and applies graph embedding and
Methods and Supplementary Fig. 3a–f). Global MTU analysis revealed diffusion analysis for trajectory reconstruction (Fig. 2a). We measured

illuminates spatiotemporal dynamics of retinal organoid formation. window proportion along the pseudotime, grouped by timepoint. e, Heat map
a, Schematic overview of the Laminator algorithm developed for laminar window showing fluorescence intensity measurements (Hoechst and CTBP2) or MTU
segmentation, vertical orientation and trajectory inference. Laminar windows intensity profiles (MTU 20, MTU 25 and MTU 3) along the inner–outer laminar
measure 16.25 × 1.625 μm and are oriented on the tissue contour by maximizing axis across oriented laminar windows ordered by pseudotime. f, Representative
the Euclidean distance transform of the masked organoid for each window. oriented laminar windows from multiple positions along the pseudotime course
b, Force-directed graph embedding of laminar window clusters (numbered) showing nuclei location (Hoechst, white), proliferating cells (MTU 20, blue) and
colored by timepoint. Node size represents the fraction of laminar windows plexiform layers (MTU 25, red) along the inner–outer laminar axis. g, Scatter plot
within a timepoint. Insets colored by timepoints show representative oriented showing signal similarity of each laminar window to adult laminar windows over
laminar windows per cluster. c, Graph with laminar window clusters colored pseudotime. Dots are colored by timepoint. c, cluster; Wk, week.

Article https://doi.org/10.1038/s41587-023-01747-2

immunofluorescence intensities, MTU distributions and nuclei features non-retinal regions and aggregates of RPE. We selected retinal regions
in an inner-to-outer axis per laminar window, clustered the features per and used a force-directed graph to analyze the relationships between
oriented laminar window and visualized relationships within and across clusters across the timepoints (Fig. 2b) and applied diffusion analysis
organoids using a UMAP embedding (Supplementary Fig. 5a–c). From to establish a trajectory of retinal neuron layer development (Fig. 2c
this analysis, we could distinguish various structural components of and Supplementary Fig. 5d,e). The reconstructed pseudo-temporal
the tissue, such as highly organized nuclear layers, disorganized zones, trajectory reflected a temporal progression (Fig. 2d) and enabled us to

 a Reconstruction of laminar organization dynamics (Laminator)
 Circumference contour
 Wk39 Target 1
 and distance transform
 Off-target
 Laminar Segment and orient
 2
 window laminar windows

 ter

 UMAP 2
 Ou
 Window heterogeneity
 3 analysis
 Integrate timepoints
 4 Graph embedding

 er
 Inn
 Nuclei UMAP 1 Trajectory inference
 1 2 3

 b
 7 8
 Laminar window 3 Adult-c1
 cluster graph
 3 1
 5
 3
 1 1
 1 1 3
 2 11
 9 7

 4 5
 2
 6
 10 9
 Wk6-c4 Wk12-c3 Wk18-c1 Wk24-c9 Wk39-c3

 Size 0.25 1.00 Weights 0.7 0.8 0.9

 c d Timepoint
 6
 Pseudotime Pt
 (Pt) 3,000 12
 18
 2,000
 24
 1,000
 39
 Adult
 Pt 0 1,000 2,000 3,000

 e Stage 1 (6–12)
 Stage 2 (18–24) Stage 3 (24–39) f
 MTU 20 Hoechst MTU 25
 Time

 ONL
 Nuclei

 Hoechst (nuclei) OPL
 Inner–outer laminar axis

 INL
 IPL
 High

 MTU 20 proliferating cells
 Organoid Pt Adult
 g 1.0
 Timepoint
 MTU 25 plexiform layers
 6
 Maturation score

 0.5 12
 18
 24
 Low

 0
 MTU 3 photoreceptor cytoplasm 39
 Adult
 Intensity

 –0.5

 Synapse (CTBP2) –1.0

 0 1,000 2,000 3,000 0 1,000 2,000 3,000
 Pt Pt

Article https://doi.org/10.1038/s41587-023-01747-2

 a c e NR2E3 EBF3 Peak-1 Peak-5 f Cone
 Human BC Cone
 Rod
 iPSCs AC Rod

 UMAP-2
 HC BC
 MG
 Retinal RPE
 organoids RGC RPE
(6–46 weeks)
 Time course

 RPC UMAP-1
 Cell type NEUROG1 TFAP2A Peak-2 Peak-6
 AC
 RPC
 Cowan et al. HC
 RGC
 Initial/intermediate
 Integrated MG Terminal
 Multiome
 atlas
 No. of
 scRNA-seq PRDM8 TFAP2B Peak-3 Peak-7 g Pt-dep.
 Expr.
 norm. Pt. targets
 + Integration
 scATAC-seq CCA + MCMF 0.25 100
 0.50 1
 200
 0.75
 0 300
 b Line MYRE
 B7 EGR2 MYRF Peak-4 Peak-8
 IMR90
 409B2-iCas9

 Timepoints (wks)
 NR2F3
 Expression Accessibility CRX
 6 10 21 30 46
 0 Max 0 Max
 TFAP2B
 EGR2
 d TFAP2A
 RPC
 RGC Max
 HC

 Expression
 AC
 BC ID1
 Cone
 Rod

 h RPC
 MG
 RPE Min
 Rods Cones BC RGC
 CYP1B1
 HES5
 NME4
 ISYNA1
 CD99
 PRSS23
 TTC9B
 ELAVL3
 GNG3
 CHRNB3
 EBF3
 EBF1
 POU4F2
 SLC18A2
 POU6F2
 CNTN2
 NEFM
 ELAVL4
 NEFL
 RAB31
 ID3
 TMSB15A
 GRIA4
 TNR
 TFAP2B
 ONECUT1
 PLXNA2
 ONECUT2
 APBB2
 PROX1
 CNTNAP2
 TFAP2A
 GAD1
 RUNX1T1
 PLPPR1
 MIR181A1HG
 NRXN1
 TMEM215
 CA10
 GNG13
 VSX1
 HPCA
 DOK6
 IGSF21
 NEUROD4
 MAP7
 CADPS
 AC023905.1
 GNAT2
 PEX5L
 KCNB2
 MYL4
 NXNL1
 SLC38A5
 RRAD
 SH3GL2
 MLXIP
 PDE6A
 CLUL1
 NR2E3
 CABP5
 SAG
 GNAT1
 REEP6
 GPR160
 PRPH2
 AL451062.1
 F3
 FLT1
 CFI
 OAF
 LGALS3
 PHLDA1
 LGI4
 WIF1
 CRYM
 RLBP1
 SFRP1
 SFRP5
 TYR
 PLD5
 OC90
 NCCRP1
 MET
 COL8A1
 ATP6V1C2
 TYRP1
 TRPM1
 RPC
 RGC Max AC HC MG RPE
 Rel. expr.

 Accessbility
 HC
 AC High
 BC
 Cone Low
 Rod
 MG
 RPE Min
 Genomic regions

human retinal organoid development. a, Paired scRNA-seq and scATAC-seq visualization in a force-directed layout, with circles representing high-resolution
were performed on a timecourse of retinal organoid development. Multiome clusters, with both RNA and chromatin access features colored by assignment.
data were also acquired and used to assist with data integration. Together with g, UMAP embedding of the inferred TF network based on co-expression and
previously published scRNA-seq data14, scRNA-seq and scATAC-seq data were inferred interaction strength between TFs. Color and size represent expression
combined into metacell representations containing both modalities using weighted pseudotime of TF regulator and PageRank centrality of each module.
CCA and MCMF. b,c, UMAP embedding of metacells colored by iPSC line (b) h, TF network colored by expression enrichment for different cell types.
or by annotated cell type (c, top) and timepoint (c, bottom). d, Heat maps Exp. norm., expression normalized; Pt, pseudotime; Pt-dep., pseudotime
showing average expression of representative marker genes (top) or chromatin dependency; Rel. expr., relative expression; wks, weeks.
accessibility (bottom) for each major cell type. e, Feature plots showing cell

observe several interesting aspects of human retinal organoid devel- Single-cell multiome analysis of human retinal organoids
opment preceding retinal lamination and spanning PR maturation To provide multiomic resolution to human retinal organoid devel-
(Fig. 2e and Supplementary Fig. 5f–h). In early phases of the trajectory, opmental dynamics, we performed scRNA-seq and scATAC-seq from
there were abundant cells in the G2/M phase of the cell cycle marked the same cell suspension across a timecourse (6–46 weeks) of human
by MKI67 and PCNA, associated nuclei localized to outer surfaces and retinal organoid development (Fig. 3a). The dataset incorporates 22
exhibited elongated shapes (Fig. 2e and Supplementary Fig. 6a). Pro- timepoints from four human iPSC lines, including iPSC lines with stable
genitor cells begin to differentiate into retinal neurons, and, subse- integration of doxycycline-inducible Cas9 in the AAVS1 safe harbor
quently, the plexiform layers emerge, becoming stratified between locus (iCas9) and previously published scRNA-seq datasets14 (Fig. 3b,
nuclei layers (Fig. 2e,f). In a later stage, PRs develop, and differentia- scRNA-seq (in total 212,781), scATAC-seq (in total 151,684), and Suption of neuronal and glial cells is established (Supplementary Figs. 5h plementary Table 2). We constructed ‘multiomic metacells’ containing
and 6b,c). Overall, there is a clear and consistent pattern across expres- information on both transcriptome and chromatin accessibility using
sion and morphological signals that retinal organoids increase in simi- minimum-cost, maximum-flow (MCMF) bipartite matching28 within
larity to the primary retina organization over the timecourse (Fig. 2g), canonical correlation analysis (CCA) space29 (Supplementary Fig. 7a).
consistent with scRNA-seq data14. We note that this reconstruction can The metacells were integrated using cluster similarity spectrum (CSS)30,
be used to analyze the dynamic location of subcellular structures, such and the integrated data were visualized using a UMAP embedding
as mitochondria and P-bodies, and tissue structures, such as collagen (Fig. 3c). In addition, we performed multiome measurements from the
and axonal fibers (Supplementary Figs. 5h and 6b,c). Altogether, these same cell (10x Genomics) at key developmental timepoints (15 weeks
data provide a high-information-content spatial representation from and 36 weeks, 13,645 cells), incorporated the cells into the integration
protein measurements of human retinal organoid laminar develop- and used the multiome data to assess the overall integration (Fig. 3c
mental dynamics. and Supplementary Fig. 7b–k). Altogether, the integration revealed

Article https://doi.org/10.1038/s41587-023-01747-2

a continuous distribution of cell states through the timecourse, with observing the transition from multipotent progenitor cells that were
rods, cones, BCs, ACs, HCs, RGCs, RPE and MG annotated (Fig. 3d). The distributed throughout the lamina into intermediates and differentihigh dimensionality of the data could be used to identify marker genes ated types that began to stratify over time to the INL and ONL (Fig. 4h,i).
and gene regulatory regions for the different cell types (Fig. 3d,e and This analysis highlighted the emergence and disappearance of RGCs
Supplementary Table 3). Indeed, the cell-type-specific gene regulatory (marked by POU4F1) around weeks 6–18, a known deficiency of current
regions overlap with cell-type-specific promoters and enhancers (Sup- retinal organoid protocols (Fig. 4h–j)13,14,35.
plementary Fig. 8), which may be useful to design cell-type-specific To evaluate our findings with an orthogonal method, we assessed
drivers for gene therapy31. These data provide a high-resolution feature the transcriptomes represented within spatially resolved nuclei using
assessment of human retinal organoid development from multipotent multiplexed detection of RNA transcripts in situ (single-molecule
progenitor states and highlight the protocol reproducibility across fluorescence in situ hybridization (FISH); Molecular Cartography).
different iPSC lines. We generated a highly resolved expression map probing 100 genes
 We next reconstructed the cell and GRNs that underlie human in retina organoids at 13 weeks and 32 weeks of development (total
retinal development. We used RNA velocity32 and CellRank33 to generate of 20 sections and eight organoids; Fig. 5, Supplementary Fig. 10 and
a terminal fate transition probability matrix based on transcriptomes, Supplementary Table 7). Gene expression can be explored across
which we used to construct a differentiation graph of high-resolution the organoid section and within laminar windows (Fig. 5a,b and
metacell clusters and assign branch identities. The graph, presented by Supplementary Fig. 10a). We developed a pipeline to segment cell
a force-directed layout, reveals diversification of retinal cell types over bodies, quantify transcripts within each nucleus and assess heterothe organoid timecourse (Fig. 3f). We used Pando34 to infer sets of posi- geneity between nuclei based on gene expression, which resolved the
tively or negatively regulated target genes (gene modules) as well as major retinal cell types at each timepoint (Fig. 5c and Supplementary
regulatory genomic regions (regulatory modules) for each annotated Fig. 10b–f). Using Laminator, we identified architectural variation
TF (Fig. 3g) and visualized module expression in a UMAP embedding. within each organoid similar to what was observed in the protein
Feature plots reveal groups of TFs that associate with the development expression space (Supplementary Fig. 11a–g). We compared the measof specific cell types (Fig. 3h), including RGC development (POU4F2 ured transcript expression within each retinal window to the predicted
and ATOH7), HC/AC/BC differentiation (TFAP2A, TFAP2B and PRDM8) transcript expression in the integrated spatiotemporal reconstrucand PR diversification (rod NR2E3; cone NEUROG1; both CRX). Globally, tion and found that most had the highest correspondence to winthis GRN shows that regulatory region accessibility and TF expression dows within the nearest previously measured timepoint (Fig. 5d).
track with stages of retinal organoid development and segregate during We analyzed the correlation between measured and predicted tranneuron diversification. script expression across laminar windows and found high correlation
 between most transcripts (Fig. 5e–g and Supplementary Fig. 11h). We
Integrated multimodal map of retinal neurogenesis also performed a power analysis to assess the ability to discern cell
We next sought to integrate the sequencing and multiplexed imaging types using this integration. From the scRNA-seq data, we generated
data to generate a multimodal spatial map of human retinal organoid clusters at different levels of resolution (L1–L6). Notably, cluster
development. We subsetted metacells from each sequencing timepoint, level 1 distinguished each of the major retinal cell populations, and
performed high-resolution clustering in the transcriptome space and each subsequent cluster segmented each major cell type into further
predicted 4i nuclei type based on correlation between transcript and biological or technical states (Fig. 5h). We then compared inferred
protein expression (Fig. 4a). In this way, the transcriptome and acces- gene expression patterns in each multimodal integrated nucleus
sible chromatin modalities could be integrated with spatially localized (containing RNA, chromatin access and protein information) with each
nuclei in the 4i dataset, such that each nucleus contains chromatin, cluster within the resolution hierarchy. We found that the integration
mRNA, protein and spatial features (multimodal nuclei; Fig. 4b and Sup- is robust to at least the L3 hierarchy, and the 4i and FISH-based integraplementary Fig. 9a). Focusing on the developed organoid (39 weeks), we tions perform similarly well (Fig. 5i). These data provide a multiplexed
highlight CRX and HES1 expression in PRs and MG, respectively (Fig. 4c), in situ map of retinal organoid transcripts at two timepoints, and the
as well as rod and MG-specific gene regulatory regions (Fig. 4d). Applied analysis supports a robust multimodal 4i and sequencing integration
to all sections and timepoints, we could map protein abundance, nuclei for identification of major cell types.
location, transcriptome and chromatin accessibility in all tissues, facili- We used our multimodal integration to identify transcriptome
tating the spatial exploration of diverse data modalities across time features that associate with spatial features. We first focused on larger
(Fig. 4e and Supplementary Fig. 9). For example, we show that VSX2 is spatial domains. Previous analyses identified MTU 6 in a 39-week orgainitially highly expressed in progenitor cells localized toward the outer noid that was distinguished by EPHB2 protein expression (Fig. 1g),
portion of the early organoid (6–12 weeks) and becomes restricted to a delineator of retinal dorsal–ventral patterning. We observed that
BCs localized in the INL in developed organoids (39 weeks) (Fig. 4f,g). multimodal nuclei in the integration also showed spatial heterogeneity
We could resolve the temporal emergence of each neuronal class, in EPHB2 transcript abundance (Supplementary Fig. 12a). We searched

human retinal neurogenesis. a, Schematic for integrating accessible chromatin, timepoints. Left metacell embedding colored based on indicated timepoint.
transcriptome and protein modalities into spatially resolved and segmented Right nuclei UMAP colored by label transfer from the transcriptome space.
nuclei. High-resolution clusters were generated from scSeq data (RNA/ATAC f, Timecourse retinal organoids colored based on VSX2 transcript expression.
metacells) of the closest matching timepoints to the imaging data. Label transfer Boxed inset shows zoom with inner (I) to outer (O) orientation. g, Heat map shows
was predicted based on correlation of RNA and protein features in sequenced VSX2 expression densities along the inner–outer and pseudotime axes. Dashed
cells and imaged nuclei, respectively. Left UMAP shows timecourse metacell lines demarcate stages (vertical) and the INL (horizontal). 1, 2 and 3 refer to the
embedding based on transcriptome and colored by cell type with 39-week cells organoid developmental stage as in Fig. 2e. h, Heat map showing expression
highlighted. Right UMAP shows nuclei embedding based on protein features of RGCs (POU4F1), MG (HES1) and PR (CRX) markers along the inner–outer and
colored according to label transfer from the transcriptome space. b, Overview pseudotime axes. i, Heat map showing nuclei type abundance densities for the
and laminar zoom of a representative 39-week retinal organoid colored based major annotated retinal organoid cell types/states along the inner–outer and
on nuclei type assignment from the label transfer. c,d, Representative 39-week pseudotime axes. j, Density plots showing proportion of each annotated nuclei
organoid nuclei colored based on RNA expression (c) or chromatin accessibility type over the trajectory. Inter., intermediate; Pt, pseudotime; wk, weeks.
(d) of markers for PRs (CRX, c; chr17-81655189–81657223, d) or MG (HES1,

Article https://doi.org/10.1038/s41587-023-01747-2

the multimodal nuclei for transcripts that spatially correlated and genes positively spatially correlated with EPHB2 related to metabolism
anti-correlated with EPHB2 expression. This analysis identified gene and (axon) development, suggesting that cells high in EPHB2 might be
sets enriched in nuclei in EPHB2-high and EPHB2-low domains, and developmentally active and that some aspects of retinal axon pathfindthese genes had high expression in MGs and BCs and lower expression ing mechanisms can be detected in retinal organoids (Supplementary
in PRs (Supplementary Fig. 12b,c). We performed Gene Ontology (GO) Table 4 and Supplementary Fig. 12d,e). These data support our previous
term enrichment analysis of genes positively or negatively spatially cor- observation that patterning domains can emerge in retinal organoids,
related with EPHB2. This revealed general sensory or neuronal terms for which have an impact on longer-term expression patterns that emerge
genes negatively spatially correlated with EPHB2. In contrast, terms of after weeks in culture.

 a Multimodal spatial integration
 BC Cone
 Integrated b
 AC Rod multimodal
 ATAC RNA Protein
 HC MG registration
 39 wk
 RGC RPE
 RPC 150 µm

 Label Outer
 transfer
 scSeq 4i

 UMAP 2
 - RNA anchored RNA/ATAC
 - Subset timepoint metacells Segmented
 - High-resolution clustering nuclei
 - Predict 4i nuclei UMAP 1 Inner

 c CRX HES1 d Rod ATAC MG ATAC

 150 µm 150 µm

 Transcript expression Low High Chromatin accessibility Low High

 e 6 wk 12 wk 18 wk 24 wk

 Metacells
 UMAP Nuclei

 f VSX2 O O O

 100 µm I 100 µm I 100 µm I
 6 wk 12 wk 18 wk

 O O g 1 2 3 O

 100 µm I 100 µm I
 24 wk 39wk VSX2 I
 Transcript expression Low High Pt
 0 1,000 2,000 3,000

 h Expression i Cell type abundance j Proportion
 POU4F1 RPC HC
 RPC

 RGC
 Rod Inter.
 HES1 RGC AC BC
 HC
 AC
 Cone
 Intermediate MG Rod
 BC
 CRX Cone MG
 Type abundance Low High
 0 3,000
 0
 0
 0

 00

 0
 0
 0

 00

 Pt
 00
 00

 00
 00
 1,0

 1,0

 3,
 2,

 2,
 3,

 Pt Pt

Article https://doi.org/10.1038/s41587-023-01747-2

 a Multiplexed FISH (100 genes) Wk 13 Outer (O) Wk 13 O Wk 32
 b
 O

 Wk 13
 100 µm
 I
 Wk 32 Baysor NR2F1 ONECUT1 OTX2 PDE6B PPIB RBP3 SLC17A7 STAT3 VEGFA VSX2
 O

 b

 Wk 32
 100 µm

 OTX2 VSX2 SOX9 PDE6B MKI67 SLC17A7 Inner (I) I I

c Baysor segmentation d Measured (FISH) vs. e VSX2 f VSX2 g Comparison between h Integration power analysis
 inferred transcript (4i) Wk 13 4i and FISH integration
 VSX2 O Wk 13

 (imputed RNA FISH − RNA FISH)
 0.6
 RNA Wk 13 Inter- BC HC RPC RPE
 Wk 13 FISH

 Correlation
 Wk 13 Rod mediate Cone L1
 0.4 OTX2 AC RGC MG
 2.5 0.6 ONECUT1
 6.0
 4.0 VSX2 L2

 Correlation
 0.2
 Distance

 2.0 0.4 VEGFA SLC17A7
 5.0 0 I NR2F1 L3
 0 STAT3
 0.2 0.6 PDE6B
 Wk 32 0.2
 Wk 32 PPIB L4
 VSX2
UMAP2

 7.5 O 0.6 RBP3
 RNA 0

 Correlation
 FISH
 0.4 L5
 UMAP1 6 12 18 24 39 0 0.2 0.4 0.6
 5.0
 Wk 32 4i timepoints (weeks) 2.5 0.2 ONECUT1 Wk 32 L6
 Wk 32 0
 I 0
 0.6
 NR2F1
 VSX2
 SLC17A7
 PDE6B log
 i 4i vs. scRNA-seq FISH vs. scRNA-seq
 2.5 0 0.4 VEGFA RNA 10 10
 RNA 4i (transferred) 0.4 RBP3
 Protein 4i VSX2 count 8 8
 RNA FISH (measured) STAT3 OTX2 5
 measured expression
 Distance

 Distances
 6 6
 RNA 4i (transferred) PPIB
UMAP2

 0.2 4 4
 5.0 RNA FISH 4
 Protein 4i (measured) 3 2
 measured 2
 RNA FISH (transferred) 0 2 0 0
 UMAP1 RNA 4i RNA FISH (measured)
 (transferred) –2 –2
 RPC MG RPE Rod Cone 7.5 Protein 4i (transferred) 0 0.2 0.4 0.6 –4
 RNA FISH RNA FISH (measured) Levels 1
 BC AC HC RGC Intermediate (transferred) Correlation 3 4 5 6 1 3 4 5 6
 (imputed RNA 4i − RNA FISH)

evaluation of multimodal integration. a, Multiplexed RNA FISH in retinal protein (black) and RNA (gray) from 4i and FISH experiments and transferred
organoid cryosections (week 13 and week 32). A six-transcript overlay (100 RNA from integrated 4i nuclei (dark blue) and FISH cells (light blue). f, Bar plots
probed) is shown at two resolutions for one organoid at each timepoint. Scale show spatially constrained correlation within paired multimodal metacells
bar, 100 µm; zoom, 55.2 × 165.6 µm. b, Transcript detection in a representative (FISH and 4i) between transferred and measured RNA and measured protein
oriented (inner, I; outer, O) window for a week 13 (top) and a week 32 (bottom) and RNA. g, Scatter plot shows correlation between imputed and measured
organoid. First panel shows Baysor segmentation. c, Heterogeneity analysis of RNA within segmented features from FISH (y axis) and 4i (x axis) datasets. Genes
Baysor-segmented cell bodies from all organoid sections at week 13 (top) and (circles) are colored by transcript detection in the single-cell sequencing data.
week 32 (bottom). UMAP projection from FISH expression features and colored by h, Power analysis comparing expression correlations in 4i and FISH transcriptome
labels transferred from sequenced cells. Major types are distinguished, including integrations. Clusters from scRNA-seq data were generated at different resolution
RGCs, HCs, cones, ACs, rods, BCs and MG. d, Box plots show averaged Euclidean levels. Major cell types were distinguished at level 1 (L1), with subsequent
genomic distances of matched spatial zones in week 13 (top, n = 1,697) and week resolution describing biological and technical cell states. i, Box plots show
32 (bottom, n = 1,666) laminar windows from FISH data and transferred transcript distribution of distances calculated between the best and second-best matches
expression in the multimodal integrated laminar windows from each 4i timepoint. for label transfer (Seurat) between scRNA-seq cells and 4i (left, n = 366,540) and
e, Left, VSX2 transcript detection in extended centroids of segmented cell bodies FISH (right, n = 64,579) nuclei. The data suggest that both methods, on average,
within an oriented week 13 (top) and week 32 (bottom) window. Right, line plot perform equivalently well and broadly resolve cell types. Wk, week.

 We next used the integrated dataset to explore spatiotemporal profiles in a UMAP embedding identified significant heterogeneity
features of cell type development, focusing on the emergence and among the RGC neighborhoods (Supplementary Fig. 14b,c). Inspection
loss of RGCs. We previously observed that RGCs emerge at 6 weeks, of RGC neighborhoods on the images revealed differential location patbecome abundant at 12 weeks, but are nearly absent at 18 weeks of terns between many of the clusters (Supplementary Fig. 14d). Interestdevelopment (Fig. 4). Nuclei in 6-week organoids could be ordered ingly, certain RGC neighborhoods were localized within the interior of
into a retinal precursor cell (RPC) to RGC differentiation trajectory the organoid, and nuclei within these neighborhood clusters exhibited
based on either protein or RNA features (Supplementary Fig. 13a–d). cell death features, including intense Hoechst staining and nuclei
This ordering revealed gene expression changes during differentiation fragmentation37, and other protein and MTU characteristics (Supple-
(Supplementary Fig. 13e,f), and spatial analysis showed that RGCs mentary Fig. 14e–g). We explored heterogeneity in the transcriptome
accumulate at the organoid inner surface (Supplementary Fig. 13g), space and identified two major RGC types, distinguished by the presconsistent with in vivo observations of RGC development36. To under- ence and absence of POU4F1 expression (Supplementary Fig. 14h).
stand the loss of RGCs, we established a neighborhood analysis to Subclustering revealed 11 clusters, and differential expression analysis
explore microenvironmental variation in RGC locations. We segmented between clusters highlighted cluster 6 as having a strong signature of
cell neighborhoods through a 6.5-μm radial extension from each RGC apoptosis (Supplementary Fig. 14i,j). GO analysis revealed pathways
nuclei centroid, and then we searched for heterogeneity among neigh- and specific genes that may be involved in RGC preservation or inducborhoods based on annotated features (for example, MTUs, protein, tion of cell death, which have implications for human vision disorders,
RNA and chromatin access) (Supplementary Fig. 14a). Clustering and such as glaucoma38,39 (Supplementary Table 5). Altogether, these data
visualizing RGC neighborhoods from 12-week organoids based on MTU and analyses showcase how the digital retinal multimodal map can

Article https://doi.org/10.1038/s41587-023-01747-2

a c e h
 OTX2 profiles GRN Mosaic pertubation f 24 wks
 Rods HES6 PIK3R1
 Inferred
 O TF nodes 3 gRNA per target 0.3
 0 OTX2

 GRN (OTX2 target)
 + dummies 2 7 target
 MG
 OTX2 MAP1B
 OTX2 1 targeted 0
Transcript expression I 3 TUBB2B
 6
 iCas9 retinal CYP26A1
 NRL NEUROG1 organoids BC –0.3 TUBA1A

 UMAP 2
 HES6 19 wks
 AC/HC –0.3 0 0.3
 5
Motif enrichment DLX2 ID4 scRNA-seq
 SOX2 Control DE (OTX2 KO vs. CL)
 amplicon-seq 22–24 wks UMAP 1
 High

 POU4F2
 DLX1 HES5 g i –log10(P-Bonferroni) j Module activity
 (OTX2 LOF vs. CL) 0 2 4 6 8 10 12
Regulome activity (+) OTX2 direct targets Differential
 Positive regulation (+) activity Cell junction 1
 Co-expression modules
 Negative regulation (–) Post-synaptic membrane
 RPE
 1 Nervous system development

 OTX2-targeting module clusters
 d 0.8 MG Zinc ion binding
 Low

Regulome activity (–) OTX2(+) 2
 Glutamate ion channel activity
 AC
 Correlation to cell fates

0 1,000 2,000 3,000 Axon guidance
 RGC 2 Actin cytoskeleton organization
 Pt 0
 Visual perception
b Transcript 3
 –0.4 HC

 High
 Motif Cilium assembly
 OTX2(–) BC Photoreceptor outer segment
 0.6 Cilium morphogenesis
 Rod 3 4
 Motile cilium
 0 Cone Phototransduction
 –0.4 Cell types Photoreceptor cell maintenance
 1 2 3 4 5
 Photoreceptor disc membrane
 OTX2-targeting module clusters 5
 RPE
 Rods
 Cones
 BC
 AC
 HC
 RGC
 MG

 4 Plasma membrane

 Low
 Expression Enrichment Module Module Min Max
0 Max 0 Max ER Fold enrichment
 DA activity 5
 –10 –1 0 1 10 Lysosome 1 9.5 0 3,000
 Pt
 Signed –log10(P)

regulome activity differences between retinal cell types. a, Heat map shows scRNA-seq and amplicon-seq were performed on suspensions at 22–24 weeks.
OTX2 transcript expression, motif enrichment and positive regulome (+) and f, UMAP projection colored by annotated cell type (left) or by cells with OTX2
negative regulome (−) densities along the inner (I) to outer (O) and pseudotime (top right, red) or dummy (bottom right, dark gray) gRNAs detected. Gray cells
axes from the reconstructed multimodal map. b, Transcriptome-based UMAP represent unknown or other targeted TFs. g, Heat map showing gene expression
metacell plot showing OTX2 expression (left) or motif enrichment within modules (columns) and their activity in cell clusters (rows). Left sidebar shows
accessible chromatin peaks (right). c, Global TF GRN highlighting OTX2 (black cluster type. Bottom sidebar shows module clusters. Top side bar shows the
node) and the predicted positively (red) and negatively (blue) regulated genes differential module activity for the OTX2 gRNA cells relative to dummy control.
within the inferred OTX2 regulon. d, Box plots show the distribution of OTX2 h, Scatter plot showing the relationship between differential expression between
positively (top, +) or negatively (bottom, −) regulated targets within the GRN OTX2 LOF and control (x axis) and predicted directionality in the OTX2 GRN
based on the expression correlation of each target to different retinal cell fates. targets (y axis). i, GO enrichments for modules that are significantly affected
e, Schematic of single-cell perturbation experiment using the CROP-seq method. by OTX2 LOF. j, Heat map shows the module activity scores across the retinal
Three gRNAs targeting OTX2 and four other TFs (Supplementary Information) organoid spatiotemporal multimodal map. CL, control; KO, knockout;
were used together with a random non-targeting gRNA (dummy). Retinal Pt, pseudotime; wks, weeks; ER, endoplasmic reticulum.

be used to explore gene regulation and spatial feature co-variation, for scRNA-seq (10x Genomics) and target amplicon sequencing (Supand cell neighborhood analyses can be performed for any cell type or plementary Fig. 15d,e). Based on RNA expression measurements, we
spatial domain. generated a UMAP embedding, analyzed cell type heterogeneity and
 annotated the major cell types recovered in the experiment (Supple-
Mosaic perturbation of TF regulomes mentary Fig. 15f). We performed expression module analysis42 and
The GRN analyses and integrated multimodal map illuminated TFs that found that OTX2 LOF cells showed the strongest effect, with OTX2
are central regulators of development. To begin to understand how module genes being significantly misregulated (Supplementary
TFs regulate retinal cell type identity in human tissues, we established Fig. 15g–i). We, therefore, focused subsequent detailed analyses on the
a pooled loss of function (LOF) experiment based on the CROP-seq effect of perturbation of the OTX2 regulon.
protocol34,40 in developed retinal organoids (Supplementary Fig. 15a). We first explored OTX2 in our digital organoid map. The OTX2 reg-
We targeted five TFs (OTX2, NRL, CRX, VSX2 and PAX6) that are impor- ulon is distinguished by predicted positive regulation of genes enriched
tant for retinal development41 and are expressed dynamically over the in rods, cones and BCs relative to the other retinal cell types, with the
organoid developmental timecourse (Supplementary Fig. 15b,c and OTX2 motif being enriched within accessible chromatin of these cell
BCs and the RPE (Supplementary Fig. 15c). VSX2 and PAX6 are expressed and positively regulated OTX2 targets are NRL, NEUROG1 and HES6,
in RPCs, and their expression is maintained in BCs and RGCs/ACs/HCs, which are TFs that are enriched in rods, cones or BCs, respectively.
respectively (Supplementary Fig. 15c). Conversely, direct negative targets are DLX1/2, HES5 and POU4F2, which
 To perform the LOF experiment, we established an inducible Cas9 are TFs enriched in fates that are predicted to be negatively regulated
nuclease (409B2-iCas9) line and validated that it produces each of the by OTX2 (Fig. 6c,d)24.
major retina neuronal cell types (Fig. 3c,d). We generated a lentiviral The CROP-seq experiment provided sufficient OTX2 guide RNA
library containing a GFP reporter34, targeting guides against OTX2, NRL, (gRNA) detection across the different retinal cell types to assess
CRX, VSX2 and PAX6 and a non-targeting guide as control. The iCas9 the impact of predicted LOF on each cell type expression module
line was used to generate retinal organoids, which were infected with (Fig. 6e–g). For OTX2 LOF, we found that RGC, HC and AC expression
the pooled lentiviral library at 19 weeks of development, to investigate modules were enriched and PR and BC expression modules were
the role of the TFs in a timepoint in which all cell types are already depleted in comparison to control cells (Fig. 6g). In addition, there
present. At 3–5 weeks after infection, GFP+ cells were sorted and used was a correlation between GRN OTX2 target predicted regulation

Article https://doi.org/10.1038/s41587-023-01747-2

directionality and differentially expressed genes between OTX2 LOF exclusion for downstream analysis. By establishing a novel approach
and control cells (Fig. 6h). The most depleted expression module in the to assess intra-organoid and inter-organoid heterogeneity based on
OTX2 LOF condition (module 3) had ontology enrichments for many tissue segmentation and clustering, we can overcome barriers assoaspects of visual perception, consistent with the role of OTX2 in main- ciated with organoid heterogeneity. Segmented tissue units can be
taining PR identity and the critical role of OTX2 in the development and arranged into trajectories to reconstruct morphological transitions
maintenance of the human visual system (Fig. 6i). Finally, we highlight (for example, lamination), and cell neighborhoods can be grouped to
the activity of these OTX2 regulated modules over the digital organoid study microenvironmental variation associated with cellular states. We
map, showing that module 3 emerges temporally upon PR differentia- expect that these approaches will be useful for diverse organoid systion as they localize to outer positions within the lamina (Fig. 6j). tems to explore tissue structure, to understand tissue developmental
 These findings are consistent with previous results in non-human dynamics, to assess fidelity to primary counterparts and to quantify
model systems showing that OTX2 governs sister fate choices in the phenotypes in disease or other perturbation conditions.
developing retina, particularly directing and maintaining PR and BC Moving forward, a comprehensive organoid atlas will require
programs, while inhibiting the AC/HC/RGC programs24,25,43. In addi- integration of additional modalities together with temporal and spatial
tion, we looked at how each targeted TF in the CROP-seq affects the features. Future integrations may be achieved through incorporating
regulome of the other TFs targeted in the CROP-seq (Supplementary ‘bridge’ measurements, such as combining 4i with measurements
on the PAX6 (refs. 24,25) and CRX regulomes25. Because it is currently example, CITE-seq44) or through combined multiplexed transcript
unknown how OTX2 controls PAX6, we used the GRN to predict this and protein detection in the same or adjacent sections. Combined
regulation and found that PAX6 might be indirectly downregulated by with experimental perturbations and models of disease, such virtual
OTX2 through DLX2 and POU2F2 (Supplementary Fig. 15k). Accord- or digital organoid systems will allow for comparative analyses across
ingly, DLX2 and POU2F2 regulomes are strongly affected by OTX2 LOF organoid phenotype spaces that span molecular and tissue scales. We
(Supplementary Fig. 15l). Altogether, these data bring together spati- envision that such data-rich representations of organoid phenotypic
otemporal GRN analysis with perturbations using genetic manipulation landscapes will provide new insights into human biology and disease.
to highlight the utility of organoids and digital multimodal maps to In conclusion, we demonstrate that 4i on developing organoid
gain holistic insight into human retinal neurogenesis. tissues is a robust, reproducible and high-resolution method to profile
 heterogeneity across many samples and scales. The method is capable
Discussion of resolving cell types, morphological structures, organelles and pro-
Organoid models of human physiology and pathophysiology are tein localization, thereby providing analytical access to spatial features
becoming important multicellular systems for basic and translational beyond gene expression. We developed Laminator as a tool to classify
research. However, the field has lacked integrative experimental and stereotypic tissue windows and reconstruct tissue developmental
computational approaches for phenotyping organoid development dynamics from timecourse multiplexed image data. We show that
across spatial and temporal scales. Here we show that 4i on tissues com- multiplexed protein maps and single-cell transcriptome and chromabined with single-cell genomics can be a flexible and broadly applicable tin data can be integrated, and this phenotyping approach, especially
approach to generate high-information-content spatial and molecular across a developmental timecourse, can provide powerful multimodal
descriptions of organoids and their primary counterparts covering information about cell type differentiation within a microenvironment.
chromatin, transcriptome and protein features. 4i on tissues is attrac- We provide a computational pipeline for 4i analysis and multimodal
tive as it uses off-the-shelf antibodies to measure protein expression integration that can be adopted by the research community.
spatially, and methods can be established for tissue processing, liquid
handling and confocal imaging that provide data spanning subcel- Online content
lular, cellular and tissue scales. In a single experiment, we generated Any methods, additional references, Nature Portfolio reporting suma 53-plexed protein map from 41 samples covering multiple organoid maries, source data, extended data, supplementary information,
timepoints, crossing length scales of ~150 nm to several millimeters in acknowledgements, peer review information; details of author cona total of more than 400 million multiplexed measurements. We also tributions and competing interests; and statements of data and code
generated a 100-plexed RNA transcript map from 20 samples with availability are available at https://doi.org/10.1038/s41587-023-01747-2.
similar resolution. Sequencing and imaging data integration at this
level of multiplexing can robustly resolve major retinal cell types using References
both the in situ protein and RNA measurements and resolve biologically 1. Schier, A. F. Single-cell biology: beyond the sum of its parts. Nat.
meaningful cell states. Cell type and state resolution is dependent on Methods 17, 17–20 (2020).
antibody and RNA probe selection, which can be adapted per experi- 2. Zhu, C., Preissl, S. & Ren, B. Single-cell multimodal omics: the
ment. Our holistic analysis of organoid tissues provides data-driven power of many. Nat. Methods 17, 11–14 (2020).
approaches to explore global and local spatial heterogeneity. Thus, 3. Hickey, J. W. et al. Spatial mapping of protein composition and
our multimodal map, together with previous assessments, suggests tissue organization: a primer for multiplexed antibody-based
an optimistic view of the predictive capacity of retinal organoids. imaging. Nat. Methods 19, 284–295 (2022).
 Indeed, we provide evidence that the well-known master regulator 4. Chiaradia, I. & Lancaster, M. A. Brain organoids for the study of
OTX2 is required to maintain retinal neuronal identities, consistent human neurobiology at the interface of in vitro and in vivo. Nat.
with results on non-human models24,25. The vast majority of chromatin Neurosci. 23, 1496–1508 (2020).
access, gene and protein expression profiles and cell differentiation 5. Takebe, T. & Wells, J. M. Organoids by design. Science 364,
profiles support the striking correspondence between organoid and 956–959 (2019).
primary retina counterparts. Human retinal organoids develop over 6. Rood, J. E. et al. Toward a common coordinate framework for the
many months in culture, and our data suggest that mosaic perturba- human body. Cell 179, 1455–1467 (2019).
tion experiments can be performed at any point in development using 7. Camp, J. G., Platt, R. & Treutlein, B. Mapping human cell
inducible Cas9 iPSC lines to interrogate gene LOF. We also observed phenotypes to genotypes with single-cell genomics. Science
that organoids contain disorganized or malformed regions that are 365, 1401–1405 (2019).
not often highlighted in the literature, and we developed methods that 8. Hao, Y. et al. Integrated analysis of multimodal single-cell data.
allow classification of tissue types to allow for targeted inclusion or Cell 184, 3573–3587 (2021).

Article https://doi.org/10.1038/s41587-023-01747-2

9. Brancati, G., Treutlein, B. & Camp, J. G. Resolving 29. Stuart, T. et al. Comprehensive integration of single-cell data. Cell
 neurodevelopmental and vision disorders using organoid 177, 1888–1902 (2019).
 single-cell multi-omics. Neuron 107, 1000–1013 (2020). 30. He, Z., Brazovskaja, A., Ebert, S., Camp, J. G. & Treutlein, B. CSS:
10. Sasai, Y. Cytosystems dynamics in self-organization of tissue cluster similarity spectrum integration of single-cell genomics
 architecture. Nature 493, 318–326 (2013). data. Genome Biol. 21, 224 (2020).
11. Nakano, T. et al. Self-formation of optic cups and storable 31. Jüttner, J. et al. Targeting neuronal and glial cell types with
 stratified neural retina from human ESCs. Cell Stem Cell 10, synthetic promoter AAVs in mice, non-human primates and
 771–785 (2012). humans. Nat. Neurosci. 22, 1345–1356 (2019).
12. Eiraku, M. et al. Self-organizing optic-cup morphogenesis in 32. La Manno, G. et al. RNA velocity of single cells. Nature 560,
 three-dimensional culture. Nature 472, 51–56 (2011). 494–498 (2018).
13. Zhong, X. et al. Generation of three-dimensional retinal tissue 33. Lange, M. et al. CellRank for directed single-cell fate mapping.
 with functional photoreceptors from human iPSCs. Nat. Commun. Nat. Methods 19, 159–170 (2022).
 5, 4047 (2014). 34. Fleck, J. S. et al. Inferring and perturbing cell fate regulomes in
14. Cowan, C. S. et al. Cell types of the human retina and its human brain organoids. Nature https://doi.org/10.1038/s41586-
 organoids at single-cell resolution. Cell 182, 1623–1640 (2020). 022-05279-8 (2022).
15. Afanasyeva, T. A. V. et al. A look into retinal organoids: methods, 35. Capowski, E. E. et al. Reproducibility and staging of 3D human
 analytical techniques, and applications. Cell. Mol. Life Sci. 78, retinal organoids across multiple pluripotent stem cell lines.
 6505–6532 (2021). Development 146, dev171686 (2019).
16. Sridhar, A. et al. Single-cell transcriptomic comparison of human 36. Amini, R., Rocha-Martins, M. & Norden, C. Neuronal migration and
 fetal retina, hPSC-derived retinal organoids, and long-term retinal lamination in the vertebrate retina. Front. Neurosci. 11, 742 (2017).
 cultures. Cell Rep. 30, 1644–1659 (2020). 37. Crowley, L. C., Marfell, B. J. & Waterhouse, N. J. Analyzing cell
17. Lu, Y. et al. Single-cell analysis of human retina identifies death by nuclear staining with Hoechst 33342. Cold Spring Harb.
 evolutionarily conserved and species-specific mechanisms Protoc. https://doi.org/10.1101/pdb.prot087205 (2016).
 controlling development. Dev. Cell 53, 473–491 (2020). 38. Almasieh, M., Wilson, A. M., Morquette, B., Cueva Vargas, J. L. &
18. Parfitt, D. A. et al. Identification and correction of mechanisms Di Polo, A. The molecular basis of retinal ganglion cell death in
 underlying inherited blindness in human iPSC-derived optic cups. glaucoma. Prog. Retin. Eye Res. 31, 152–181 (2012).
 Cell Stem Cell 18, 769–781 (2016). 39. Vrabec, J. P. & Levin, L. A. The neurobiology of cell death in
19. Khan, M. et al. Detailed phenotyping and therapeutic strategies glaucoma. Eye 21, S11–S14 (2007).
 for intronic ABCA4 variants in Stargardt disease. Mol. Ther. Nucleic 40. Datlinger, P. et al. Pooled CRISPR screening with single-cell
 Acids 21, 412–427 (2020). transcriptome readout. Nat. Methods 14, 297–301 (2017).
20. Dulla, K. et al. Splice-modulating oligonucleotide QR-110 restores 41. Swaroop, A., Kim, D. & Forrest, D. Transcriptional regulation of
 CEP290 mRNA and function in human c. 2991+1655A>G LCA10 photoreceptor development and homeostasis in the mammalian
 models. Mol. Ther. Nucleic Acids 12, 730–740 (2018). retina. Nat. Rev. Neurosci. 11, 563–576 (2010).
21. Kruczek, K. et al. Gene therapy of dominant CRX-Leber congenital 42. Jin, X. et al. In vivo Perturb-Seq reveals neuronal and glial
 amaurosis using patient stem cell-derived retinal organoids. Stem abnormalities associated with autism risk genes. Science 370,
 Cell Rep. 16, 252–263 (2021). eaaz6063 (2020).
22. Gut, G., Herrmann, M. D. & Pelkmans, L. Multiplexed protein 43. Sato, S. et al. Dkk3-Cre BAC transgenic mouse line: a tool for
 maps link subcellular organization to cellular states. Science 361, highly efficient gene deletion in retinal progenitor cells. Genesis
 eaar7042 (2018). 45, 502–507 (2007).
23. Wang, S., Sengel, C., Emerson, M. M. & Cepko, C. L. A gene 44. Stoeckius, M. et al. Simultaneous epitope and transcriptome
 regulatory network controls the binary fate decision of rod measurement in single cells. Nat. Methods 14, 865–868 (2017).
 and bipolar cells in the vertebrate retina. Dev. Cell 30,
 513–527 (2014). Publisher’s note Springer Nature remains neutral with regard to
24. Ghinia Tegla, M. G. et al. OTX2 represses sister cell fate choices jurisdictional claims in published maps and institutional affiliations.
 in the developing retina to promote photoreceptor specification.
 eLife 9, e54279 (2020). Open Access This article is licensed under a Creative Commons
25. Nishida, A. et al. Otx2 homeobox gene controls retinal Attribution 4.0 International License, which permits use, sharing,
 photoreceptor cell fate and pineal gland development. Nat. adaptation, distribution and reproduction in any medium or format,
 Neurosci. 6, 1255–1263 (2003). as long as you give appropriate credit to the original author(s) and the
26. Marstal, K., Berendsen, F., Staring, M. & Klein, S. SimpleElastix: a source, provide a link to the Creative Commons license, and indicate
 user-friendly, multi-lingual library for medical image registration. if changes were made. The images or other third party material in this
 In: Proc. of the 2016 IEEE Conference on Computer Vision and article are included in the article’s Creative Commons license, unless
 Pattern Recognition Workshops (CVPRW) (IEEE, 2016); https://doi. indicated otherwise in a credit line to the material. If material is not
 org/10.1109/CVPRW.2016.78 included in the article’s Creative Commons license and your intended
27. Birgbauer, E., Cowan, C. A., Sretavan, D. W. & Henkemeyer, M. use is not permitted by statutory regulation or exceeds the permitted
 Kinase independent function of EphB receptors in retinal axon use, you will need to obtain permission directly from the copyright
 pathfinding to the optic disc from dorsal but not ventral retina. holder. To view a copy of this license, visit http://creativecommons.
 Development 127, 1231–1241 (2000). org/licenses/by/4.0/.
28. Stark, S. G. et al. SCIM: universal single-cell matching with
 unpaired feature sets. Bioinformatics 36, i919–i927 (2020). © The Author(s) 2023

Article https://doi.org/10.1038/s41587-023-01747-2

Methods for 2 h at room temperature and stabilized for 2 h in PAXgene Tis-
Primary human tissue samples sue STABILIZER (Qiagen, 765512). Organoids were allowed to sink
The human retina tissue was obtained from an anonymous multi-organ O/N in 30% sucrose in PBS (w/v) solution at 4 °C, embedded in OCT
donor by sampling non-transplantable eye tissue that was removed in and frozen in 2-methylbutane (Sigma-Aldrich, 106056) on dry ice and
the course of cornea harvesting for transplantation14. The donor had stored at −80 °C. Organoids were cryosectioned (10 µm), and slices
no documented history of eye disease, and the personal identifier was were placed within the capture areas of cold glass slides provided by
anonymized before processing. All tissue samples were obtained in Resolve Biosciences. Samples were transported on dry ice for analysis,
accordance with the tenets of the Declaration of Helsinki, and experi- whereby tissue sections were thawed and washed at room temperature
mental protocols were approved by the local ethics committee. The in isopropanol, 95% ethanol and 70% ethanol. Fixed samples were used
sample included in this study is designated by the ID R-00646_06. for Molecular Cartography (100-plex combinatorial single-molecule
 FISH (smFISH)) according to the manufacturer’s instructions
Stem cell and organoid culture (protocol 1.3). In brief, tissues were treated with buffer DST1, primed
Four human iPSC lines were used: B7 (01F49i-N-B7 (ref. 14)), IMR90 for 30 min at 37 °C and hybridized overnight with gene probes. Samples
(iPS (IMR90)-4-DL-01, WiCell), B7-iCas9 (01F49i-N-B7-iCas9) and were washed and fluorescently tagged for imaging.
409B2-iCas9 (ref. 45). B7 iCas9 carried integration of the construct
pAAVS1-ieCas9 (ref. 46) in AAVS1 locus. For 4i experiments, B7 orga- Multiplexed smFISH probe design
noids at 6, 12, 18, 24 and 39 weeks were used. iPSCs were cultured in The 100-gene panel (Supplementary Table 7) was selected using genmTeSR1 (STEMCELL Technologies, 85857) or mTeSR Plus (STEMCELL eBasisR48, given the 4i gene panel and the top five marker genes of major
Technologies, 100-0276) supplemented with penicillin–streptomycin cell types as the pre-selected genes. Genes with transcripts per million
(1:200, Gibco, 15140122) on Matrigel-coated plates (Corning, 354277). (TPM) > 10,000 in any major cell type were excluded. Probes were
Cells were split 1–2 times per week after dissociation with EDTA in designed using the highest-scoring probes from Resolve’s proprietary
DPBS (0.5 mM) (Gibco, 12605010). Media were supplemented with algorithm based on full-length protein-coding transcript sequences
rho-associated protein kinase (ROCK) inhibitor Y-27632 (5 μM, STEM- from the ENSEMBL database (GENCODE annotation tag ‘basic’)49,50. To
CELL Technologies, 72302) after thawing. Cells tested negative by filter highly repetitive regions, the abundance of k-mers was obtained
polymerase chain reaction (PCR) for mycoplasma infection (Venor from the background transcriptome using Jellyfish51. Target sequences
GeM Classic, Minerva Biolabs). All cell lines showed normal karyotypes were scanned for all k-mers, with preference to rare k-mers for probe
upon generation; the 409B2-iCas9 line acquired a common stem cell design. A probe candidate was generated by extending seed sequences
abnormality over time45; and the B7-iCas9 acquired a duplication in to a threshold hybridization stability, and probes were filtered through
the centromeric region of long arm of chr20: q11.21–q11.22 (a known assessing mapping to a background transcriptome using Thermoadaptation to cell culture growth conditions). All organoids were gener- nucleotideBLAST52. Specific probes were then scored based on the
ated using the AMASS protocol14. To generate retinal organoids from number of on-target matches (isoforms), which were weighted by their
the B7 and IMR90 lines, 600 cells were seeded in each microwell of an associated APPRIS level53, favoring principal isoforms and those with
agarose chamber (MicroTissues 3D Petri Dish micro-mold, Z764019). protein-coding binding sites.
409B2-iCas9 organoids were generated with 1,500 cells per microwell
and treated with BMP4 (55 ng ml−1, Bio-Techne, 314-BP) on day 6 with Multiplexed smFISH imaging
half medium change on days 9, 12 and 15 (ref. 47). For the multiplexed Imaging was performed on a Zeiss Celldiscoverer 7 at ×25 magnifica-
FISH experiment, 300 cells were used for each organoid. tion, with the ×50 Plan Apochromat water immersion objective, NA of
 1.2 and a CD7 CMOS camera (Zeiss Axiocam Mono 712, 3.45-µm pixel
4i sample preparation size). Image settings were optimized for each signal, 1,000-ms exposure
Retinal organoids were embedded in 1% low melting agarose at ~37 °C. per FISH channel and 20 ms for DAPI. z-stacks were recorded for each
Embedded organoids were fixed in 4% paraformaldehyde (PFA) in PBS channel according to the Nyquist–Shannon principle. Two channels
at 4 °C overnight. Primary human retina samples were fixed in 4% PFA in were imaged in parallel. Eight imaging rounds were performed to
PBS at 4 °C overnight without agarose embedding. Post-fixation sam- obtain 16 z-stacks per sample. Automation of the staining and imaging
ples were transferred to 70% ethanol for at least 30 min before paraffin cycles was achieved using a Python script using the scripting API of the
embedding. A 96-well format cover slip (NEXTERION coverslips, 1535661) Zeiss ZEN software. For improved nuclei segmentation, DAPI was reimwas coated with poly-l-lysine (Sigma-Aldrich, P4832) for 1 h at room aged after the experiment with conditions identical to the 4i imaging.
temperature. Tissues were microtome-sectioned (3 μm) and transferred
to the coated 96-well coverslip and then incubated at 37 °C for at least 4i imaging
1 h before deparaffinization (60° for 45 min, 2 ×3 min Neo-Clear (Merck), Iterative staining and elution cycles22 included Hoechst (Invitrogen,
2 ×3 min 100% ethanol, 1 ×3 min 96% ethanol, 1 ×70% ethanol, 1 ×5 min 33342) to the secondary antibody staining solution at a dilution of
ddH2O). Samples were then fixed in 4% PFA in PBS for 15 min at room 1:500. Pipetting was automated on a Hamilton STAR robotic system.
temperature. For antigen retrieval, the sample plate was transferred to Secondary antibodies were applied at a dilution of 1:500. Primary
800 ml of 1 mM citrate buffer (pH 6.0, 0.05% Tween 20, sterile filtered) antibodies and dilutions used can be found in Supplementary Table 1.
and heated to 100 °C in a microwave (Milestone Micromed T/T Mega) for Imaging was performed using a Nikon Ti2 inverted microscope with a
20 min. Samples in the citrate buffer cooled at approximately room tem- Yokogawa CSU- W1 SoRa spinning disk add-on and an ORCA-Flash4.0
perature for ~2 h with an open lid. The cover glass was removed from the Digital CMOS camera, C11440, and NIS-Elements software. A ×40
buffer and patted dry between the samples with a tissue paper wrapped magnification was achieved using the Nikon PLAN APO ×40/1.25 SIL
around a glass slide. Care was taken that the samples never dried out. The MRD73400 objective. The laser settings were kept constant throughcover glass was then attached to the bottom of a 96-well self-adhesive out the experiment—20% UV (405 nm), 20% green (488 nm), 20% red
super structure (Merck, GBL204969), placing each sample into a well, (561 nm) and 40% far red (640 nm) with 100-ms exposure each. Each
and wells were filled with PBS until further processing. two channels, 405 nm and 561 nm or 488 nm and 640 nm, were acquired
 in parallel. Twenty percent of the camera sensors at each side were
Multiplexed single-molecule FISH sample preparation cropped to minimize shading effects and maximize stitching accu-
Retinal organoids (week 13 and week 32, cell line B7, four organoids racy, and 10% overlap was used for stitching. Images were acquired as
per timepoint) were fixed in PAXgene Tissue FIX (Qiagen, 765312) z-stacks with a total of 6-μm thickness and 0.5-μm distance between

Article https://doi.org/10.1038/s41587-023-01747-2

image planes. Every image consisted of a 6 × 6 tiling array. The image and color-channel-specific mean (reverse z-scoring)22. Finally, every
cycling strategy constituted ‘staining cycles’ (including elution and image channel was scaled to 0–1, where 0 is the bottom 1st percentile,
restaining) and ‘elution cycles’ (including elution and mock staining and 1 is the upper 99th percentile across all images.
steps without addition of antibodies). The elution cycles were performed every six cycles, allowing assessment of background signal MTUs
across the experiment (Supplementary Table 1). The elution cycles Pixel clustering22 was performed on normalized and scaled values
were used for background subtraction. In each staining cycle, three pri- per sample and globally across all samples. For global clustering, a
mary and secondary antibody combinations and a Hoechst stain were normalized global pixel matrix was generated by appending a random
imaged (rabbit antibody, green, 488 nm; mouse antibody, red, 568 nm; subset of every sample matrix row-wise by a factor of 1,000, but, for
third species antibody, far red, 647 nm; Supplementary Table 1). the single-sample clustering, the process used a random subset only
Certain protein stains were excluded by visual examination. on an individual sample. In both cases, FlowSOM57 was used to gener-
 ate a self-organized pixel map (30 × 30 grid, Euclidean distance, 10
Image pre-processing and registration runs). Median intensities of the fSOM output clusters were further
Background subtraction was achieved through acquiring a dark-field clustered using phenograph58. The number of k-nearest neighbors
image across z-stacks and fluorescence settings identical to stained specified for phenograph clustering was chosen by locating the inflecimage acquisitions but with lasers off. For each channel, an average tion point (neighbor numbers versus number of clusters detected)
intensity projection per tile and an average of all tiles were generated, using KneeLocator of the kneed package59. All pixels were assigned
resulting in dark-field images. Sample image tiles were maximum to the phenograph clusters by closest Euclidean distance in 4i intenintensity z-projected, and, for each channel, the dark-field images were sity measurement space. MTU images were generated by placing
subtracted from every tile, without shading correction. Stitching was cluster-assigned pixels into the masks outlining the organoid images
performed after maximum intensity z-projection using multichannel and assigning colors to pixels according to the assigned cluster number.
images with a Fiji plugin54. Hoechst images were used to align images
across all cycles using SimpleElastix55, and degradation of Hoechst Nuclei segmentation and features
staining required iterative image alignment (images cycle00 - cycle6 Nuclei were segmented using iterative optimization of Cellpose60
to cycle01, cycle07 - cycle11 to cycle06, cycle12 - cycle16 to cycle11, parameters based on Otsu thresholding of the Hoechst signal from the
cycle17 - cycle21 to cycle16). A tissue mask from the Hoechst channel in reference cycle images. The parameters used were model_type: cyto,
the reference cycle facilitated alignment. Alignment was performed in diameter: 35, flow_threshold: 0.8, cellprob_threshold: 0 and channels:
two steps: a rigid transformation followed by an affine transformation. [0, 0]. Nuclei features were retrieved using the segmented nuclei, the
The parameters used for the SimpleElastix algorithm (Supplementary normalized pixel matrix and the regionprops_table function of the
every cycle and every sample were assessed for alignment accuracy. In stain are the bottom 5th and top 5th percentiles, median, mean and
cases in which alignment was suboptimal, different cycles were chosen pixel count (sum of all intensity values per nucleus). Spatial features,
as reference to improve the alignment. radial distance and nuclei density were measured per nucleus. For
 radial distance, the refined mask was distance transformed, and the
Image masking, denoising and background removal mean distance value per nucleus was measured. For nuclei density,
ATP1A1 (membrane) and TUBA4A stains were used to generate tissue an elliptical structuring element with 100 × 100 pixels61 was used as a
masks and isolate primary objects, by scaling images to the bottom 1st kernel, and the number of nuclei in a kernel around the centerpoint of
and upper 99th percentiles, divided by 2 and summed across images. each nucleus was used as a nuclear density measurement. For visualiza-
Additionally, Otsu thresholding, dilation, expansion and closing of tion, nuclei features median fluorescence intensity values were scaled
holes ensured that no tissue was excluded in tissue masking. All images using the StandardScaler algorithm62, and a UMAP embedding63 was
were cropped to the bounding box based on these masks and denoised calculated from the first eight principal components (PCs) of the scaled
using the denoise_nl_means algorithm from scikit image in fast mode56. features. Clustering was performed using the AgglomerativeClustering
For denoising, a sigma was estimated from the images. Further param- algorithm of the sklearn package62, and the number of clusters was set
eters were patch_size = 5, patch_distance = 6, cutoff distance (h) = 0.8 × to 8 for clustering of a single replicate.
estimated sigma. Several stainings had high spurious signals in areas
corresponding to collagen-labeled areas, which were subsetted and Reconstruction of laminar organization dynamics
excluded (Supplementary Table 1). Elution cycles bracketing imag- Contour outlines of all organoid samples and the adult primary saming cycles were used to support background removal. Elution cycle ple were extracted using the skimage function find_contours()56 after
images were scaled to the upper and lower 1st percentiles, multiplied applying a Gaussian filter (σ = 50) and Otsu thresholding to the respecby the factor according to the desired proportion and summed. A fast tive mask images. Contour coordinates for the primary adult sample
non-negative least squares algorithm (https://github.com/jvendrow/ were filtered to mark the outer circumference. Distance transformafnnls) was used to gauge a factor with which to multiply the background tions were generated using the ndimage function distance_transform_
model before subtracting it from the respective foreground image. edt() on respective mask images and applying a Gaussian filter (σ = 25).
 The center of the outer edges of the laminar windows (100 × 1,000
Pixel matrix normalization pixels, 16.25 × 162.5 μm) were positioned on every 100th coordinate
After registration, every sample has a defined pixel grid that is consist- of the respective contour outlines and oriented along the inner–outer
ent across all cycles, and a matrix can be generated in which every row axis by iteratively rotating each window on their respective distance
corresponds to a pixel and every column to a signal measurement. transformed image and maximizing the sum of captured distance trans-
Imaging conditions were constant within every color channel through- formation signal under each laminar window. Intensity profiles were
out the experiment. To account for remaining signal divergences, extracted for all protein and MTU modalities by averaging across the
samples were normalized while preserving divergent signals due to inner–outer axis of each laminar window. Laminar windows positioned
biological differences. All images were combined per timepoint to in straight contours and related to organoid regions outside of the field
generate a pixel–signal matrix. For each timepoint, we calculated the of view were removed, and windows with low signal or within damaged
mean and s.d. per stain channel, z-scored every image, multiplied it by tissue were excluded by filtering windows for having more than 99%
the timepoint and color-channel-specific s.d. and added the timepoint pixels with assigned MTUs. The laminar window intensity profiles of

Article https://doi.org/10.1038/s41587-023-01747-2

each protein and MTU modality were then reverse z-scored according 43-10070-50) and a 40-μm filter (pluriSelect Mini, 43-10040-40). Cell
to organoid section and timepoint and scaled between 0 and 1. Inten- counts were assessed with a trypan blue assay on the automated cell
sity profiles were smoothed by applying a one-dimensional (1D) mean counter Countess (Thermo Fisher Scientific). For scATAC-seq, nuclei
filter (window size = 20) and downsampled by a factor of 2. Distances were isolated according to the protocol provided by 10x Genomics
between laminar windows were calculated by fast Fourier transforming using the low input protocol and a lysis time of 3 min. Nuclei were
the intensity profiles and calculating the Euclidean distances of the first loaded in a concentration that would result in a recovery of 10,000
10 frequency components for each feature using the TSDist package in nuclei. scATAC-seq libraries were generated with the Chromium Single
R64. The resulting distance matrices were analyzed using the DistatisR Cell ATAC version 1.1 Library & Gel Bead Kit and sequenced on Illumina’s
method65. Laminar tissue heterogeneity was assessed by diffusion NovaSeq platform, NextSeq 550 or HiSeq 4000. For scRNA-seq, up to
analysis66 of the log10(x + 1) transformed and across features aggre- 8,000 cells were targeted, and scRNA-seq libraries were generated
gated distance matrix of laminar window intensity profiles. Results with the Chromium Single Cell 3′ version 3.1 Library & Gel Bead Kit.
were then visualized by calculating UMAP embeddings for timepoint Libraries were pooled and sequenced on llumina’s NovaSeq platform,
subsets of the first 10 diffusion components (DCs) and clustering NextSeq 550 or HiSeq 4000. Combined scRNA-seq and scATAC-seq
laminar windows of each timepoint by performing Louvain clustering (multiome) were generated with the Chromium Single Cell Multiome
on the respective UMAP embeddings. Clustering performance and ATAC + Gene Expression kit. Nuclei were isolated as described for
properties of laminar window clusters were evaluated by reconstruct- scATAC-seq. The gene expression and accessibility libraries were FAB
ing the MTU images for all oriented laminar windows and ordered by treated and sequenced on Illumina’s NovaSeq platform.
timepoint-specific pseudotime. Louvain clusters were also mapped
onto Hoechst stain images of each organoid, and clusters were selected Single-cell sequencing data pre-processing and multimodal
for each timepoint not overlapping pigmented epithelium or other data integration
disorganized areas. All Louvain clusters from the primary tissue were For the scRNA-seq data of each retinal organoid sample, Cell Ranger
retained and merged. A trajectory of laminar windows for the selected (10x Genomics, version 4.0.0) with default parameters was used to align
Louvain clusters (week 6: n = 5; week 12: n = 5; week 18: n = 3; week 24: reads to the human reference (GRCh38, 10x Genomics, version 3.1.0)
n = 4; week 39: n = 4; adult: n = 1) were then reconstructed by applying to generate the transcript count matrix for cells. Additional quality
diffusion pseudotime analysis. control was performed by excluding cells with detected transcript num-
 A maturation score was calculated by measuring similarity of lami- ber fewer than 1,500 or higher than 20,000 as well as those with high
nar windows to the start and endpoint of the trajectory. The averaged mitochondrial transcript percentage (>20% for all the samples, except
compromised distances (DistatisR) to the upper and lower 5% quantile >40% for GB2_scRNAseq). The exonic and intronic count matrices
of pseudo-temporal ordered laminar windows were calculated, sub- were generated via dropEst67. For the scATAC-seq data of each retinal
tracted from each other and scaled between −1 and 1. A constrained organoid sample, Cell Ranger ATAC (10x Genomics, version 1.2.0) with
force-directed graph layout of laminar window Louvain clusters was default parameters was used to align reads to the human reference
generated by first filtering edges between clusters for being from the (GRCh38, 10x Genomics, version 1.1.0) to generate the peak fragment
same or adjacent timepoints and then calculating edge weights by count matrix for cells. Additional quality control was performed by
averaging the corresponding inter-laminar window cluster compro- excluding cells with detected ATAC fragments fewer than 200 or more
mised distances to construct a k-nearest neighbors graph (k = 4) from than 10,000; cells with fewer than 20% fragments in the called peaks;
the resulting adjacency matrix. Exemplary laminar window clusters cells with fragments at the blacklist genomic areas >2.5%; cells with
for each timepoint were illustrated by randomly selecting 10 win- nucleosome signal >3; and cells with transcriptional start site (TSS)<2.
dows from each cluster and appending reconstructed MTU laminar To integrate scRNA-seq and scATAC-seq data measuring the same
windows along the pseudo-temporal trajectory. Spatiotemporal heat cell suspension of a retinal organoid sample, we modified a procemap visualization of features along the trajectory was achieved by dure34 as follows. Seurat (version 4.0.0) was used to normalize and
scaling intensity profiles between the lower 1% and upper 5% quan- log-transform the scRNA-seq data, identify highly variable genes
tiles and smoothened by position on the inner–outer axis along the (vst method, 3,000 genes, followed by excluding mitochondrial and
pseudo-temporal axis by applying a 1D mean filter (window size = 15). ribosomal genes), data scaling, principal component analysis (PCA,
Average heat map of protein and MTU intensities along the pseudotime select top 20 PCs) and Louvain clustering (resolution = 0.5). Avertrajectory were generated by averaging intensity profiles across the age transcriptome profiles were calculated for each cluster. Signac
inner–outer axis and smoothed with a 1D mean filter (window size = 25) (version 1.4.0) was used to normalize the scATAC-seq data (default
along the pseudo-temporal axis. settings); perform partial singular value decomposition (SVD) on the
 normalized TFIDF of peaks with fragment detected in more than 0.5%
scRNA-seq, scATAC-seq and multiome for the developmental of cells to obtain the latent semantic indexing (LSI) representation;
timecourse and Louvain clustering (resolution = 0.5) based on the 2nd to 30th LSI
Retinal organoids were generated from four different stem cell lines (B7, components. Gene activity scores of annotated genes in each cell of
IMR90.4, 409B2-iCas9 and B7-iCas9). Then, 1–3 organoids of the same the scATAC-seq data were calculated using Signac, and average gene
batch were pooled and dissociated at multiple timepoints across the activity scores were obtained for each scATAC-seq cluster. For each
organoid developmental timecourse (Supplementary Table 2). Orga- scRNA-seq cluster, the scATAC-seq cluster with the highest correlation
noids were washed three times with HBSS without Ca2+/Mg2+ (STEM- across scRNA-seq highly variable genes that have non-zero gene activity
CELL Technologies, 37250). Single-cell suspensions were obtained scores in the scATAC-seq data was identified, and vice versa, resultusing a papain-based dissociation kit (Miltenyi Biotec, 130-092-628)14. ing in a bipartite nearest neighbor network of clusters that contains
In brief, 1 ml of pre-warmed papain solution was added to the orga- multiple cluster components that are disconnected from each other.
noids and incubated for 10 min at 37 °C. To facilitate dissociation, Next, CCA, implemented in Seurat, was performed on the scRNA-seq
the mix was pipette-mixed every 5 min with a p1000. Enzyme mix A data and the scATAC-seq data represented by the gene activity scores
was added and mixed by inversion and incubated for 10 min at 37 °C. based on the anchoring features selected by Seurat (same number as
Samples were pipette-mixed until tissue dissociation was confirmed the highly variable genes in the scRNA-seq data). An MCMF analysis
via visual inspection. After incubation, cells were centrifuged for 5 min was applied to cells from the two modalities in each cluster compoat 300g and 4 °C. Cells were resuspended in 250 μl of PBS + 0.04% BSA nent. This constrained MCMF bipartite matching procedure resulted
and sequentially filtered through a 70-μm filter (pluriSelect Mini, in bipartite edges, each of which connects one cell in the scRNA-seq

Article https://doi.org/10.1038/s41587-023-01747-2

data with one cell in the scATAC-seq data. For each cell in the scRNA-seq were transferred to the scATAC-seq data for those cells with only one
data with at least one cell in the scATAC-seq data paired, a bimodal paired cell in the scRNA-seq data or multiple paired cells but all sharing
metacell was formed, with the RNA component being the scRNA-seq the same cluster label. For the rest of the cells, a network propagation
data and the ATAC component being the union fragments of the paired procedure was developed to infer their corresponding cluster labels
scATAC-seq cell. as follows. First, three unweighted k-nearest neighbor (k = 20) graphs
 To evaluate the integration performance, an unweighted k-nearest were generated for the scATAC-seq cells, based on the LSI, PCA-reduced
neighbor (k = 20) graph was obtained for the scRNA-seq and scATAC-seq CSS and Harmony representation, respectively. The three graphs were
sample separately, based on Euclidean distances across the top 20 PCs averaged to form a weighted k-nearest neighbor graph. The adjacency
for the scRNA-seq data and Euclidean distances across the 2nd to 30th matrix of the resulting k-nearest neighbor graph was obtained and
LSI components for the scATAC-seq data. We defined the distance row-normalized (that is, sum of each row is 1). The normalized adjabetween two cells as the shortest distance on the k-nearest neigh- cency matrix, denoted as the propagation matrix P, was further modibor graph and then calculated the modal structure matching score fied, so that, for any cell i that has a unique transferred cluster label
(MSMS), which was defined as the Spearman correlation between the from the scRNA-seq data, Pi,i = 1 and Pi,j = 0 if i ≠ j. This propagation
pairwise distances of cells in scRNA-seq with at least one cell in the matrix was then used to perform network propagation as St = P × St−1,
scATAC-seq data paired and the pairwise distances of the paired cells in where S0 is the initial transferred cluster identity matrix: S0i,j = 1 if cell
the scATAC-seq. A sample integration with MSMS < 0.1 was considered i has a paired cell in the scRNA-seq data in cluster j, otherwise 0. The
as a failure and was not used when forming the bimodal metacells. propagation was performed 100 times. The cluster with the highest
 For the multiome data, Cell Ranger ARC (10x Genomics, version propagated score was considered as the transferred cluster label of a
2.0.0) was used to align reads of both the RNA library and ATAC library given cell. The transferred-label-based cleanup was then performed
to the human reference (GRCh38, 10x Genomics, version 2020-A-2.0.0) by excluding cells with no paired cells in the scRNA-seq data as well as
to generate both the transcript and peak fragment count matrices. cells with transferred cluster labels matching the mesenchymal or brain
Additional quality control was applied with varied criteria for the clusters. Afterwards, the similar procedure of dimension reduction and
two samples, on the transcript count number, on the ATAC fragment data integration across samples was applied. A UMAP embedding was
number and on mitochondrial transcript percentages. To generate a generated based on the PCA-reduced CSS representation.
unified peak list to combine the chromatin accessibility profiles in different retinal organoid samples, we grouped all the scATAC-seq data Cell type annotation and developmental trajectory
into four groups based on organoid ages (0–10 weeks, 11–20 weeks, characterization
21–30 weeks and >30 weeks) and used MACS2 to perform peak calling Based on the combinatorial expression of canonical cell type markon each group separately and merge (using the Signac-implemented ers in the mentioned Louvain clusters (resolution = 0.5), cells in the
wrapper function CallPeaks in default parameters). Based on the new integrated retinal organoid cell atlas were coarsely annotated as rods,
peak list, the fragment number per peak of cells in the scATAC-seq and cones, BCs, ACs/HCs, RGCs, RPCs, MG, RPE cells and others. To further
multiome data were requantified. refine the annotation, we subsetted cells annotated as AC/HC, identi-
 To integrate single-cell data across timepoints, we merged the fied highly variable genes (default parameters) on the AC/HC subset,
scRNA-seq data (which contained ATAC-integrated metacells and cells scaled the data, performed PCA (top 10 PCs), integrated data from
without paired scATAC-seq data) and multiome data, together with a different samples by MNN69 using the wrapper function in the R packpublic scRNA-seq data of retinal organoids14. Focusing on the tran- age SeuratWrappers with default parameters and performed Louvain
scriptomic profiles, highly variable genes (vst method, 3,000 genes) clustering on the MNN representation (resolution = 0.5). Among those
were identified for each of the three datasets, and those identified in clusters, distinct ACs and HCs were identified. A similar procedure
at least two datasets were considered as the overall highly variable was applied to cells annotated as RGCs. Among the Louvain clusters
genes. Data scaling (cell cycle scores regressed out) and PCA (top (resolution = 0.3), cells were split into RGCs and precursors, and nine
20 PCs) were performed, and sample integration was performed using annotated cell types (RPCs and eight terminal cell types—rods, cones,
CSS30 stratified on samples (cluster resolution = 1). PCA (top 20 PCs) BCs, ACs, HCs, RGCs, MG and RPE) were considered as well-defined cell
was applied to the resulting CSS matrix to generate the PCA-reduced types, whereas the rest of cells were considered as intermediate cell
CSS representation. Louvain clustering (resolution = 0.1) was applied, states. The average expression profiles of each cell type and the norand one resulting cluster (cluster 6) was excluded for its expression of malized transcriptomic similarity between cell types were calculated.
mesenchymal cell markers (for example, DCN). The same procedure Cell type annotation and normalized transcriptomic similarities were
was applied to the remaining cells, resulting in the new PCA-reduced transferred to the scATAC-seq atlas using the network propagation pro-
CSS representation of the data. Louvain clustering (resolution = 0.5) cedure described above, based on a new weighted k-nearest neighbor
was performed, and cells in three of the clusters were further excluded graph from the recalculated LSI, CSS and Harmony representation of
from the following analysis, for their expression of brain cell markers the cleaned-up cells in the scATAC-seq data.
(for example, FOXG1 and GFAP). The UMAP embedding of the remain- Marker genes were identified by comparing expression between
ing cells was generated given their PCA-reduced CSS representation. cell types using the presto package in R combining multiple criteria
 Cells of all the scATAC-seq data, as well as those of the multiome (Benjamini–Hochberg-corrected two-sided Wilcoxon test P < 0.01, area
data, were merged and integrated, considering their accessibility under the curve (AUC) > 0.7, average fold change (FC) > 1.2, detection
profiles across the unified peak list, using CSS stratified on samples, rate difference >20%, being detected in fewer than 20% of the other
after data normalization with TFIDF and generating LSI representation cells and excluding mitochondrial and ribosomal genes), ordered by
with SVD (2nd to 30th LSI components) using peaks detected in more cluster detection rates. Marker accessible peaks were defined as 1 with
than 0.5% of cells. PCA was performed on the resulting CSS matrix to Benjamini–Hochberg-corrected two-sided Wilcoxon test P < 0.01,
get the PCA-reduced CSS representation (top 20 PCs). Harmony68 was AUC > 0.51 and the ratio of detection rates in/out of the cluster >5,
also performed based on the 2nd to 30th LSI components with default ordered by the detection rate differences.
parameters to generate a Harmony representation. Louvain clustering scVelo70 was performed on the scRNA-seq data based on the sto-
(resolution = 0.5) was performed based on the PCA-reduced CSS repre- chastic RNA velocity model. The PCA-reduced CSS representation
sentation, and the clusters with enriched cells without any paired cells was used as the transcriptomic data representation. The RNA velocin the scRNA-seq data (Bonferroni-corrected one-sided Fisher exact test ity transition matrix and velocity pseudotime were both obtained
P < 0.01) were excluded. Next, the cluster labels of the scRNA-seq cells with default parameters. CellRank analysis33 was then applied to the

Article https://doi.org/10.1038/s41587-023-01747-2

same cells using a hybrid kernel (50% velocity kernel and 50% velocity relationship was set to 0. PCA (top 20 PCs) was then applied to conpseudotime kernel), with the eight terminal cell types considered as vert the linkage score matrix to represent each TF, which was used as
terminal states, to calculate the terminal state probabilities. Network the input to generate the UMAP embedding of the TFs. For each TF
propagation was used to transfer both the velocity pseudotime and in the GRN, its expression pseudotime was calculated as the average
the terminal state probabilities to other cells, based on the unweighted pseudotime of cell state representatives weighted by the expression
k-nearest neighbor(k = 50) graph calculated from the PCA-reduced level of the TF in different cell state representatives. The pseudotime
CSS representation. dependency of the TF is calculated as R2 between its expression across
 We constructed a graph abstraction of the differentiation trajecto- cell state representatives and the predicted values of a smooth splines
ries to different cell types from RPC as follows. Cells were grouped into model of expression against pseudotime (degree = 3).
three groups—ACs, HCs and others—and Louvain clustering (resolution = 20) was applied to the PCA-reduced CSS representation of cells Multimodal spatial integration
in each group to get high-resolution clusters, which were then pooled, To integrate the spatially resolved time course of 4i nuclei with the
as the cell state representatives. Cell metadata, including categorical multimodal single-cell sequencing (scSeq) dataset, we established
(for example, cell type annotation) and numeric (for example, velocity an integration pipeline in Seurat (version 4.0.0) in which we perform
pseudotime and CellRank terminal state probabilities) information, high-resolution clustering in RNA space and transfer these metacluster
were summarized to the clusters with either max-pooling or mean. labels to the 4i data by CCA anchoring. Protein stain intensity features of
PAGA, as implemented in scanpy, was used to compute connectivity segmented 4i nuclei from the organoid samples of the developmental
between clusters given the PCA-reduced CSS representation (n_neigh- timecourse and the primary adult sample were log(x + 1)-transformed
bors = 20). Two clusters were connected if all the following three cri- and imported into individual Seurat objects. Several protein stains
teria were satisfied: PAGA connectivity >0.2; one cluster being one were excluded (Supplementary Table 1) due to prior quality assessk-nearest neighbor (k = 20) of the other cluster in the summarized ment and protein stains that do not have an associated gene in the
CellRank terminal state probability space; and the two clusters do RNA expression data (MAPK1/MAPK3, Serotonin, NPC and Hoechst).
not belong to different terminal cell types. The connection was direc- For each timepoint in the developmental timecourse (weeks 6, 12, 18,
tional, from the cluster with lower pseudotime to the one with higher. 24 and 39), the respective samples were integrated by CCA anchoring
A force-directed layout of the graph was generated for visualization. using the Seurat functions FindIntegrationAnchors(dims = 1:10) and
 To further refine cell type branching and trajectory estimates, we IntegrateData(dims = 1:10). Subsequently, PCA was performed on the
chose five clusters with the lowest velocity pseudotime as roots and integrated samples, and UMAP embeddings were generated from
performed 100,000 random walks toward a node with zero to-degree, the first 10 PCs for each timepoint. The adult sample was processed in
discarding non-terminal nodes. For random walks reaching each of the same manner but skipping the integration procedure.
the eight terminal cell types, the frequencies of passing by each node Integration was performed for each timepoint of the 4i dataset
in the graph were counted and normalized by the number of random separately by selecting respective matching and/or adjacent timewalks reaching that terminal cell type. For each node, the resulting points in the multimodal scSeq data. To maximize the proportion of
normalized frequencies to different terminal cell types were further ATAC-paired cells in the subsets, we matched week 6 of the 4i data with
normalized by the sum to get the estimated likelihoods of the cell state week 6 of the multimodal scSeq data; week 12 with weeks 11, 12 and 13;
differentiating into different terminal cell types. Any likelihood less week 18 with week 18; week 24 with week 24; week 39 with weeks 36, 38
than 1% was set to 0 and renormalized to get the final likelihood matrix. and 40; and the adult sample with weeks 36, 38, 40 and 46, respectively.
 For each subset of the multimodal scSeq data, Harmony integration68
Reconstruction of GRN governing retinal organoid was run accounting for sample grouping to evenly distribute paired
development ATAC cells among high-resolution metaclusters that were subsequently
We applied Pando34 to the pseudocell-summarized data of the computed with the Seurat function FindNeighbors(resolution = 30,
RNA-ATAC paired portion of the retinal organoid timecourse data to dim = 15). To account for low total numbers of paired ATAC cells in
infer the GRN. Pando incorporates evolutionary conservation, prior matched subsets for weeks 24 and 39, we imputed ATAC signals for
regulatory elements, data-driven open accessible regions (for exam- cells with no ATAC information within respective k-nearest neighbor
ple, peaks called in the scATAC-seq data), TF motif database and bind- graphs by applying network diffusion (n = 20). RNA expression, ATAC
ing site prediction to identify putative cis-regulatory elements and peak regions and TF motif score matrices were averaged by assigned
putative trans-regulators (that is, TFs) of each gene and fits a linear metaclusters of each respective timepoint. To spatially resolve RNA
model of gene expression against interactions of the cis-regulatory expression, ATAC peaks, cell-type-specific ATAC peak sets and TF motif
element accessibility and trans-regulator expression, followed by scores, we transferred cell type and metacluster labels from matched
statistical tests to define significant TF-motif-target triplets. Pseudo- multimodal scSeq subsets to the corresponding 4i nuclei data subsets
cells were constructed by averaging transcriptomically similar cells by CCA anchoring. For visualization of the mapped ‘Intermediate’ cell
from the same cluster of the same sample, following the procedure types in UMAP embeddings and onto organoid images, we calculated
as described previously71 and implemented in the simspec package30, mixed colors based on the maximal correlation of intermediate cells
with selection ratio of 0.1. This procedure was to decrease the noise with the defined terminal cell states for the multimodal scSeq data and
due to data sparseness, particularly chromatin accessibility data. further averaged these by metaclusters for visualizing 4i nuclei cell
The extended TF binding motif database was constructed using a types. We added the position on the inner–outer axis of each nucleus
similar procedure as described previously34, integrating JASPAR (2020 to the metadata by calculating the Euclidean distances to the respecrelease)72, CIS-BP database73 and sequence-similarity-based motif trans- tive organoid contour outlines. We also added the pseudotime rank
fer. Pando was run in default setting, except for the tf_cor threshold of respective laminar windows as a binary count matrix that accounts
being 0.05. A TF-motif-target triplet was considered as significant if for nuclei that might be positioned within overlapping neighboring
Benjamini–Hochberg-corrected P < 0.01. laminar windows. For visualization of cell type and feature distribu-
 To generate the layout of the resulting GRN highlighting TFs, tions along the inner–outer axis and pseudotime trajectory of laminar
the pairwise Pearson correlations of gene expression between dif- windows, the integrated multimodal datasets were filtered for nuclei
ferent genes across the cell state representatives defined above were that occur at least in one laminar window with assigned pseudotime
first calculated as the base TF–gene linkage score. Next, the lineage rank and then plotted as density contour estimates from pseudotime
score between any TF–gene pair with no inferred direct regulatory and inner–outer axis resolved cell type frequency or amplified feature

Article https://doi.org/10.1038/s41587-023-01747-2

count matrices. Count matrices for cell type abundances were gener- by performing Louvain clustering on the UMAP embedding. Assigned
ated by aggregating discretized nuclei positions along the inner–outer Louvain clusters were then mapped onto respective week 12 organoid
axis. To map continuous features, such as RNA expression or ATAC peak sections for visualization. We further averaged the MTU abundances
regions, count matrices of all nuclei were multiplied by their respec- within each Louvain cluster’s radial neighborhoods and applied hiertive scaled (0–1) feature matrix, amplified by a factor of 10, rounded archical clustering (Ward.D2) and visualized the results in a heat map.
and aggregated. For further visualization of the detected radial spatial neighborhoods,
 we randomly selected six neighborhoods from all analyzed week 12 sec-
EPHB2 spatial correlation analysis tions for each detected Louvain cluster and cropped respective image
Variable features (weeks 38 and 40) were detected with the Seurat collages for Hoechst stain, all MTUs and an RGB overlay of POU4F2,
function FindVariableFeatures(). We then calculated two-dimensional HSPD1 and TUBB3 protein stains as well as a selection of MTUs 6, 8,
kernel density estimations with an axis-aligned bivariate normal ker- 13, 17 and 20.
nel for all respective per nuclei resolved spatial features across all As we observed RGC nuclei with apoptotic morphologies in
organoid sections of week 39 using the kde2d() function from the R several Louvain cluster neighborhoods, we further searched for
package MASS74 on a 200 × 200 grid. In addition, we calculated respec- apoptosis-related processes in the scRNA-seq data of RGCs in weeks
tive binary mask grids by calculating density estimations just based on 11, 12 and 13. We, therefore, retrieved a list of human genes associated
nuclei positions and applying a threshold of 0.05. We then calculated with the GO term apoptotic process (GO:0006915) from the AmiGO 2
the respective spatial correlations of all selected features with EPHB2 database (http://amigo.geneontology.org/amigo/term/GO:0006915),
across all organoid samples after multiplying respective density esti- which includes genes that are positively and negatively regulating
mations with their corresponding binary mask. Pearson correlations apoptosis. We detected variable transcripts of RGCs by using the
were then averaged by feature across all analyzed organoid sections. Seurat function FindVariableFeatures(). Next, we performed PCA for
In addition, we calculated the spatial correlation of cell type distribu- detected variable features that are also present in the retrieved list of
tions with EPHB2 in the same manner as described above, selected apoptosis-related genes and used the calculated PCA to run Harmony
the top 115 positive and negative correlated features and performed integration accounting for sample groupings. Based on the first 30
GO term enrichment using the R package clusterProfiler75 setting the dimensions of the Harmony embedding, we assigned clusters with
background genes to the complete human genome. For visualization, the Seurat functions FindNeighbors() and FindClusters(resolution = 1)
we plotted heat maps of the top four positive and negative correlating and calculated a UMAP embedding. Gene markers of each detected
features as well as EPHB2 in all analyzed organoid sections. Correlation RGC cluster were identified by comparing expression of cells of one
of cell type distributions with spatial EPHB2 expression was visualized cluster to cells of other cluster cell types using the presto package in
as a heat map after applying hierarchical clustering (Ward.D2) of cell R for all detected variable features. Cluster markers were selected by
types across all analyzed sections. Results of the GO analysis were combining Benjamini–Hochberg-corrected two-sided Wilcoxon test
visualized as dot plots where we denote the detected gene ratios and P < 0.05 and AUC > 0.5 criteria. We selected the top 50 markers from
−log10(adjusted P values). A complete list of input genes and resulting this ranking and used DAVID to perform GO term enrichment analysis
GO terms is shown in Supplementary Table 4. and KEGG pathway analysis for cluster 6, which was defined by a set of
 marker genes strongly relating to apoptotic processes (Supplementary
Differentiation trajectory and cell neighborhood analysis Table 5). We calculated a score for this detected apoptotic signature
of RGCs by using the Seurat Function AddModuleScore(ctrl = 5) for the top 10
To reconstruct RGC differentiation in week 6 retinal organoids from markers of cluster 6. For visualization, we created feature plots of the
either RNA or protein information, averaged scaled RNA (for week 6 UMAP embedding for the detected clusters as well as POU4F1, POU4F2,
detected variable features) and protein abundances for all week 6 DDIT3, SCG2, ATF3 and apoptotic module scores of cluster 6.
high-resolution metaclusters in the 4i data were calculated. Subsequently, RNA and protein metaclusters were assessed separately by dif- Processing and multimodal integration of multiplexed
fusion analysis, and respective diffusion pseudotimes were obtained. smFISH data
For visualization, we calculated averaged mixed colors for each meta- Spot segmentation and pre-processing of smFISH image data were
cluster, averaged CellRank probabilities for RGCs by metacluster and performed as described76. To assign the detected spots of the multiapplied hierarchical clustering (Ward.D2) to 25 RNA transcripts that plexed smFISH data to individual cells, we applied Baysor77 for cell segshowed the highest absolute Spearman correlation against pseudotime mentation. As a prior input for segmentation, Cellpose-labeled nuclei
ranks and six transcripts whose corresponding 4i signals correlated masks from all 20 organoid slices were generated (model = ‘cyto2’,
with pseudotime (HES1, SOX9, VSX2, PAX6, POU4F2 and ONECUT2). diameter = 50, flow_threshold = −3, cellprob_threshold = 0.8).
 To analyze local, microenvironmental variation of RGC cells in Baysor was run with default settings and a specified initial estimated
the 4i data, we performed spatial resolved neighborhood analysis of cell radius of 25 to obtain respective expression matrices, spot cell
protein and MTU signals within week 12 retinal organoid sections. We assignments, centroids and convex hulls of the segmented nuclei. For
segmented RGC neighborhoods through a 40-pixel (6.5-μm) radial the visualization of spatial transcript distribution, we generated spatial
extension from each nuclei centroid and averaged respective protein multi-transcript plots as well as faceted insets of respective laminar
signals by radial position. We masked respective nuclei to exclude organized tissue for a selection of high abundant transcript of both
protein intensity signals that stem from the nuclei themselves and to timepoints. We colored all measured transcripts in the same insets by
focus on the respective radial neighborhoods. We then processed the assigned cell and generated an overlay of DAPI images (week 13 and
retrieved radial intensity profiles and reconstructed laminar organiza- week 32) and their respectively colored convex hulls for representative
tion dynamics as described above. In brief, we first applied z-scoring laminar organized tissue areas.
and scaled the intensity profiles between 0 and 1, smoothed the signals For integration of the spatially resolved FISH nuclei with the mulby applying a 1D mean filter (window size = 20), downsampled by a fac- timodal scSeq dataset, we used an integration pipeline similar to the 4i
tor of 2 and calculated respective distance matrices by applying fast integration pipeline. In brief, we imported Baysor expression matrices
Fourier transform and averaging the Euclidean distances of the first 10 into Seurat objects, and, for each timepoint in the FISH dataset (weeks 13
frequency components. We then assessed the heterogeneity of RGC and 18), the respective samples were integrated by CCA anchoring
microenvironments by applying diffusion analysis, calculating UMAP using the Seurat functions FindIntegrationAnchors(dims = 1:10) and
embeddings from the first 10 DCs and clustering radial neighborhoods IntegrateData(dims = 1:10). Then, PCA was performed on the integrated

Article https://doi.org/10.1038/s41587-023-01747-2

samples, and UMAP embeddings were generated from the first 10 PCs null hypothesis of Pearson correlation and log10(n + 1) counts of total
for each timepoint. Cell type label and high-resolution metacluster transcript abundances to related bar plots and scatter plots.
transfer from the multimodal scSeq datasets to the spatially resolved
FISH nuclei were performed in the same manner as described above Power analysis 4i and smFISH
for the 4i nuclei. For integration, we matched weeks 11, 12, 13 and 15 to To estimate the power of distinguishing different cell types or subtypes
the week 13 smFISH samples and weeks 30, 31, 32 and 34 to the week 32 using the 4i and smFISH data, we curated a graph of clusters with varied
smFISH samples. For visualization purposes, we resolved labeled ‘Inter- resolutions on transcriptome in a hierarchical manner, based on the
mediate’ cell types in the shown UMAP embeddings and organoid scRNA-seq data. The classification of cells into eight major cell types
overlays with the same color mixing approach as for the 4i nuclei. (RPCs, RGCs, HCs, ACs, BCs, cones, rods and RPE) and the intermediate
Furthermore, we averaged transcript abundance by assigned cell type state, which covers all the other non-initial and non-terminal cell states,
labels, z-scored average expression across transcripts, applied hierar- is considered as the first layer (L1). The second layer of clustering (L2)
chical clustering (Ward.D2) and visualized the results as a heat map. expanded the intermediate state into nine different clusters, the RPC
 cluster into G2M-phase RPC and other RPC clusters and the BC cluster
Multimodal spatial comparison of 4i and smFISH into BC-on and BC-off clusters, all based on the Louvain clustering
To generate laminar windows for the smFISH data, Laminator analysis (resolution = 0.3) mentioned above. Afterwards, cells of different L2
was applied in a similar manner as for the 4i data. Initial masks for clusters were split, and the Louvain clustering was applied to each
each organoid sample were created by generating binary images of subgroup with varied resolutions (0.1, 0.5 and 1) to obtain subtypes
all located spots per sample and applying a combination of dilation, of each cell type, which altogether defined the third to fifth layer of
fill holes and erosion binary operations, followed by Gaussian blur- clustering (L3–L5). Finally, the cell states used for the above-mentioned
ring, Otsu thresholding and selection of the largest segmented area graph abstraction of the differentiation trajectories were considered
(for details, see GitRepo). Tiles that were not imaged were further as the finest layer of clusters (L6). The average transcriptome profiles
masked by thresholding corresponding DAPI images and combining were calculated for every cluster on different layers by averaging the
the tile masks with their corresponding initial masks. Similarly to the transcriptome profiles of cells assigned to the cluster.
above-described Laminator analysis, organoid contours were detected, To visualize the hierarchy of clusters, we represented different
and laminar windows (100 × 1,000 pixels) were placed and oriented layers of clusters as a graph, where each cluster was a node, and two
at the same intervals along the contours. We generated individual clusters were connected by an edge only if they were from two nearby
binary images for all transcripts from the respective discretized spa- layers and the two clusters had at least one shared cell. The edge was
tial coordinates, extracted intensity profiles and applied filtering for weighted as nij / ni, where nij is the number of cells shared by the two
straight contour areas that stem from unimaged tiles, reverse z-scoring, clusters, and ni is the number of cells in the cluster at the coarser layer.
smoothing and downsampling of retrieved intensity profiles, distance Edges with weights less than 0.1 were trimmed. The cluster graph was
matrix construction and averaging, diffusion analysis and Louvain clus- then visualized using the ggraph package in R with the tree layout
tering of laminar windows with the same parameters as for the 4i data. implemented in the igraph package (the layout_as_tree function), with
 We compared and matched smFISH laminar windows with the the edge weights represented by the edge alpha-transparency.
spatiotemporal laminar window trajectory of the 4i dataset. Segmented Next, the Pearson correlation coefficient (PCC) was calculated
smFISH and 4i nuclei were assigned to their respective laminar win- between the average transcriptome profiles of each cluster and the
dows, and their position on the inner–outer axis was determined. Lami- protein abundance profile of every segmented nucleus in the 4i expernar windows (smFISH and 4i) were separated into equally spaced zones iments. For each 4i nucleus, PCC was calculated for all L1 clusters,
(n = 6) along the inner–outer axis, and pseudobulk transcriptomes whereas, for the other layers, only clusters reachable from the L1 cluswere calculated from the respective assigned nuclei’s scaled expres- ter that the nucleus was predicted to be in the integration procedure
sion values. Note that, for the 4i nuclei, we used the predicted scaled mentioned above were included. The power of discriminating different
expression values of the transcripts overlapping with the measured clusters at different layers for the 4i experiment was represented by the
transcripts of the smFISH data. Averaged Euclidean genomic distances distribution of differences between the maximal and the second-largest
of matched spatial zones between all smFISH and 4i windows were PCC in all the 4i nuclei. A similar procedure was also applied to the
calculated. Consequently, each smFISH window was paired with the Baysor segmented cells in the smFISH experiments. To estimate the
4i window with the respective minimal averaged genomic distance if background of the discrimination power, cells of each L1 cluster were
the same spatial zones were populated by nuclei as in the compared randomly grouped into two groups, each of which with the average
smFISH window. To visualize the similarity of smFISH to 4i windows transcriptome profiles calculated. For each 4i nucleus or smFISH segacross experiments, we grouped matched window pairs by 4i and mented cell, PCCs were calculated to the two average transcriptome
smFISH timepoint and plotted the respective distributions of averaged profiles of the cluster it was predicted to be. The distribution of differgenomic distances as box plots. ences between the two PCCs across all 4i nucleus or smFISH cells was
 To assess spatially constrained correlation between measured considered as the background of zero discrimination capacity.
and predicted RNA abundance, we further matched nuclei across
matched smFISH and 4i laminar windows. Each nucleus in the smFISH Vector and lentivirus preparation for perturbation
windows was paired with the 4i nucleus that had maximal Pearson experiment
correlation between the smFISH scaled expression of transcripts and The lentiviruses for perturbation experiment were produced as
predicted scaled transcript expression in the 4i nuclei. From these described34,40 with minor modifications. In brief, a modified CROP-seq
paired multimodal metacells, which possess protein-level, predicted vector carrying GFP34 was used. Three gRNAs per targeted gene (NRL,
RNA levels from 4i nuclei as well as measured and predicted RNA levels OTX2, PAX6, VSX2 and CRX) were designed using the GPP Web Portal
from smFISH, intermodality correlations for each of the measured (https://portals.broadinstitute.org/gpp/public/) and synthesized by
transcripts of the smFISH data were calculated for week 13 and week 32 IDT following40 recommendations. Moreover, a non-targeting ‘dummy’
smFISH samples. For visualization of predicted and measured RNA guide (CGCTTCCGCGGCCCGTTCAA) was added. Oligonucleotides
levels and protein levels, we calculated the respective averaged inner– were pooled in equal amounts and assembled in the vector backbone
outer intensity profiles for all modality types of VSX2, weighting 4i by Gibson isothermal assembly. The plasmid library was sequenced
laminar windows that were matched multiple times with log(n + 1). In to validate the complexity of the pooled plasmid library, and 10 ng of
addition, we added the respective 1–99% confidence intervals for the plasmid library was used for generating a sequencing library with a

Article https://doi.org/10.1038/s41587-023-01747-2

single PCR reaction. Illumina i7 and i5 indices were added by PCR, and The bimodal distribution of di suggested a group of cells with large
the library was sequenced on Illumina’s MiSeq platform. Upon valida- projection distance to the reference data, which implied failure of the
tion, lentiviruses were generated. projection—that is, cell types/states that did not exist in the reference
 data. A Gaussian mixture model was then fitted to identify those cells
‘In organoid’ CROP-seq perturbation experiment that were excluded from the following analysis. A UMAP embedding
Retinal organoids derived from 409B2-iCas9 line at 19 weeks of was generated, and Louvain clustering with varied resolutions
development were infected with the lentiviral pool described above. (0.2 and 0.6) was performed, both based on the PCA-reduced CSS
Twenty organoids were individually infected in ultra-low attachment representation of the remaining cells.
96-well plates (Costar). Each organoid was infected with 1 µl of LV To estimate the perturbation probability of each cell being
(titer = 5.61 × 108 TU ml−1) in 100 µl of medium. After 4 h, 150 µl of induced by the gRNA and Cas9 expression, we adapted the perturbamedium was added for O/N incubation. The day after, organoids tion probability calculation34, using experiments and the Louvain cluswere moved to 10-cm plates and treated with doxycycline 4 µg ml−1 ter labels (resolution = 0.6) as covariates. The resulting perturbation
for 1 week to induce Cas9. After 3 weeks, 10 organoids were dissoci- probabilities were considered as the proxy of perturbation status of
ated with the papain-based dissociation kit (Miltenyi Biotec, 130- a cell and used in the following differential expression (DE) analysis.
092-628) described previously, and GFP+ cells were enriched by The DE analysis was applied to co-expression gene modules, which
fluorescence-activated cell sorting (FACS) (Experiment 1). The other were defined in the retinal organoid timecourse cell atlas as follows.
10 organoids were processed 5 weeks after infection (Experiment 2). A k-nearest neighbor (k = 50) graph of genes detected in at least 1% of
We obtained a total of 12,000 and 7,000 GFP+ cells, respectively, and cells in the timecourse cell atlas was based on the Pearson correlation
loaded them for scRNA-seq. We note that the first sample experienced distance between gene expression across the abstracted cell state
a potential wetting error during GEM generation. scRNA-seq libraries representatives. Louvain clustering (resolution = 10) was applied to
were generated with the Chromium Single Cell 3′ version 3.1 Library & the gene k-nearest neighbor graph to identify the co-expression gene
Gel Bead Kit. The expression libraries were FAB treated and sequenced modules. The gene module activities were quantified for cells in the
on Illumina’s NovaSeq platform. timecourse atlas as well as cells in the CROP-seq data, separately, using
 the AddModuleScores function in Seurat with default parameters.
gRNA detection from single-cell cDNA An ANOVA-based DE method was then applied to the gene module
gRNA sequences from single cells were amplified from 30 ng of activity scores of each co-expression gene module, testing whether
scRNA-seq cDNA as described in ref. 34. The first PCR amplifies a the cell perturbation status of different targeting TFs significantly
broad region targeting the outer part of the U6 promoter. The second, explained variance of the activity score of a gene module in the datanested, PCR targets the inner portion of the U6 promoter adjacent set, with additional covariates, such as experiments and cell clusters
to the guide sequence and adds a TruSeq Illumina i5 adapter. Finally, (resolution = 0.6), included in the model. Co-expression gene modules
a third PCR adds Illumina sequencing i7 adaptors. PCRs were moni- with Benjamini–Hochberg-corrected P < 0.1 were considered as diftored by quantitative PCR to avoid over-amplification. The samples ferentially expressed modules (DEMs) caused by the perturbation
were purified using SPRI beads (Beckman Coulter), and libraries were of the targeting TF. The size of the DE effect was represented by a
sequenced at 1:10 proportion of the transcriptome library on Illumina’s signed −log10(P), where P is the ANOVA P value and the sign being the
NovaSeq. sign of the estimated coefficient. The resulting DEMs were clustered
 using hierarchical clustering (Ward.D2 method), given the pairwise
CROP-seq data pre-processing and analysis Pearson correlation distance across the timecourse cell state repre-
CROP-seq experiment reads were aligned to the human reference sentatives. DAVID was used to do functional enrichment analysis of
(GRCh38, 10x Genomics, version 3.1.0) with Cell Ranger (10x Genomics, genes in each cluster of DEMs. The DE analysis was also applied to the
version 4.0.0) to generate the transcript count matrix for each sample. two CROP-seq experiments separately with only the cluster label as
The amplicon sequencing reads detecting the gRNAs were aligned to the additional covariate, to estimate the robustness of the detected
the extended human reference (GRCh38-based, 10x Genomics, version DE of the identified DEMs.
3.1.0) using Cell Ranger (version 4.0.0) adding a guide-GFP construct
as an artificial chromosome. A quality control procedure34 was used Statistics and reproducibility
to extract informative gRNA transcripts detected in each cell based Imaging analysis and integration were performed on the entire dataon a Gaussian mixture model of number of reads per unique molecu- sets of the 4i and smFISH experiments, respectively. 4i and smFISH
lar identifier (UMI), resulting in a guide transcript count matrix for experiments were performed once each. They included multiple
each sample, which was binarized to obtain the final cell-to-gRNA and controls and analysis illustrating reproducibility and robustness of
cell-to-target assignments. the procedures. All images and spatial plots presented are representa-
 CROP-seq transcriptomic data were merged and normalized tive of the entire respective datasets or specific timepoints within the
using Seurat (version 4.0.0). Highly variable genes were identified respective dataset if indicated. The 4i dataset included 16 organoids
(vst method, 3,000 genes, excluding cell-cycle-related genes and mito- and one primary tissue. For each organoid timepoint, at least two
chondrial and ribosomal genes), and data scaling and PCA (top 20 PCs) organoids with at least two sections are represented with a total of
were then performed, followed by data integration by CSS and further 40 sections. The primary tissue sample is represented with a single
PCA reduction. The data were projected to the CSS space30 of the retinal section. See Supplementary Table 1 for details on the experimental
organoid timecourse, and the k-nearest neighbor (k = 50) of each cell (i) design. For the smFISH data, four organoids per timepoint week 13
in the CROP-seq data in the timecourse cell atlas (denoted as Nri), as well and week 32 were used. Week 32 organoids are represented with 12
as the average of their distances in the CSS space (denoted as di), were sections and week 13 organoids with eight sections (Supplementary
obtained. The average distance of each cell (j) in the timecourse atlas to Table 7). All the box plots presented in figures were created using the
its k-nearest neighbor (k = 50) within the atlas (d′j) was also calculated. default box plot setup in R. In brief, the midlines in boxes represent
A normalized projected distance of each cell in the CROP-seq data to medians; the widths of boxes represent the lower and upper quartiles;
the timecourse atlas was, thus, defined as the upper and lower whiskers represent values outside the middle
 50% that are no more than 1.5 times the interquartile range from the
 di = di / ( ∑ dj′ /|Nri |) . boxes; and values out of the ranges are considered as outliers, which
 j∈Nri
 are shown as dots or not shown.

Article https://doi.org/10.1038/s41587-023-01747-2

Reporting summary 59. Satopaa, V., Albrecht, J., Irwin, D. & Raghavan, B. Finding a
Further information on research design is available in the Nature Port- ‘kneedle’ in a haystack: detecting knee points in system behavior.
folio Reporting Summary linked to this article. In: Proc. of the 2011 31st International Conference on Distributed
 Computing Systems Workshops (IEEE, 2011); https://doi.org/
Data availability 10.1109/ICDCSW.2011.20
All the data can be visualized and explored via the EyeSee4is app 60. Stringer, C., Wang, T., Michaelos, M. & Pachitariu, M. Cellpose: a
(https://eyesee4is.ethz.ch/). Compressed images in JPEG format, an generalist algorithm for cellular segmentation. Nat. Methods 18,
example 4i image dataset in the raw TIFF format, multiplexed smFISH 100–106 (2021).
spot data, processed datasets of integrated scRNA-ATAC, 4i nuclei and 61. Bradski, G. The OpenCV Library. Dr. Dobbʼs J. Softw. Tools 25,
smFISH nuclei as well as the 4i-scRNA-ATAC and smFISH-scRNA-ATAC 120–123 (2000).
integrated multimodal data are available via Zenodo (https://doi. 62. Buitinck, L. et al. API design for machine learning software:
org/10.5281/zenodo.7561908)78. The raw sequencing data are available experiences from the scikit-learn project. Preprint at arXiv
via ArrayExpress under accession number E-MTAB-12622 (CROP-seq)79. https://doi.org/10.48550/arXiv.1309.0238 (2013).
The scRNA-seq and scATAC-seq data are available at ArrayExpress under 63. Sainburg, T., McInnes, L. & Gentner, T. Q. Parametric UMAP
accession number E-MTAB-12714. The B7 cell line data are available in embeddings for representation and semisupervised learning.
the European Genome-phenome Archive under accession number Neural Comput. 33, 2881–2907 (2021).
EGAS00001007065. The complete 4i image data of raw TIFF files are 64. Mori, U., Mendiburu, A. & Lozano, J. Distance measures for time
too large to provide on public repositories. They are available upon series in R: the TSdist package. R J. 8, 451–459 (2016).
reasonable request to the corresponding authors. 65. Abdi, H., O’Toole, A. J., Valentin, D. & Edelman, B. DISTATIS: the
 analysis of multiple distance matrices. In: Proc. of the 2005 IEEE
Code availability Computer Society Conference on Computer Vision and Pattern
Laminator and other code used in the analyses are available on GitHub Recognition (CVPR'05)—Workshops (IEEE, 2005); https://doi.org/
(https://github.com/quadbiolab/spatial_multimodal_retinal_organoid ). 10.1109/CVPR.2005.445
 66. Haghverdi, L., Buettner, F. & Theis, F. J. Diffusion maps for
References high-dimensional single-cell analysis of differentiation data.
45. He, Z. et al. Lineage recording in human cerebral organoids. Bioinformatics 31, 2989–2998 (2015).
 Nat. Methods 19, 90–99 (2022). 67. Petukhov, V. et al. dropEst: pipeline for accurate estimation
46. Ihry, R. J. et al. p53 inhibits CRISPR–Cas9 engineering of molecular counts in droplet-based single-cell RNA-seq
 in human pluripotent stem cells. Nat. Med. 24, 939–946 experiments. Genome Biol. 19, 78 (2018).
 (2018). 68. Korsunsky, I. et al. Fast, sensitive and accurate integration of
47. Kuwahara, A. et al. Generation of a ciliary margin-like stem cell single-cell data with Harmony. Nat. Methods 16, 1289–1296 (2019).
 niche from self-organizing human retinal tissue. Nat. Commun. 6, 69. Haghverdi, L., Lun, A. T. L., Morgan, M. D. & Marioni, J. C. Batch effects
 6286 (2015). in single-cell RNA-sequencing data are corrected by matching
48. Missarova, A. et al. geneBasis: an iterative approach for mutual nearest neighbors. Nat. Biotechnol. 36, 421–427 (2018).
 unsupervised selection of targeted gene panels from scRNA-seq. 70. Bergen, V., Lange, M., Peidli, S., Wolf, F. A. & Theis, F. J.
 Genome Biol. 22, 333 (2021). Generalizing RNA velocity to transient cell states through
49. Frankish, A. et al. GENCODE reference annotation for dynamical modeling. Nat. Biotechnol. 38, 1408–1414 (2020).
 the human and mouse genomes. Nucleic Acids Res. 47, 71. Kanton, S. et al. Organoid single-cell genomic atlas uncovers
 gky955 (2018). human-specific features of brain development. Nature 574,
50. Yates, S. C. et al. QUINT: workflow for quantification and spatial 418–422 (2019).
 analysis of features in histological images from rodent brain. 72. Fornes, O. et al. JASPAR 2020: update of the open-access
 Front. Neuroinform. 13, 75 (2019). database of transcription factor binding profiles. Nucleic Acids
51. Marçais, G. & Kingsford, C. A fast, lock-free approach for efficient Res. 48, D87–D92 (2020).
 parallel counting of occurrences of k-mers. Bioinformatics 27, 73. Weirauch, M. T. et al. Determination and inference of eukaryotic
 764–770 (2011). transcription factor sequence specificity. Cell 158, 1431–1443 (2014).
52. Gans, J. D. & Wolinsky, M. Improved assay-dependent searching 74. Venables, W. N. & Ripley, B. D. Modern Applied Statistics with S
 of nucleic acid sequence databases. Nucleic Acids Res. 36, (Springer, 2002).
 e74 (2008). 75. Wu, T. et al. clusterProfiler 4.0: a universal enrichment tool for
53. Rodriguez, J. M. et al. APPRIS 2017: principal isoforms interpreting omics data. Innovation 2, 100141 (2021).
 for multiple gene sets. Nucleic Acids Res. 46, D213–D217 76. Hu, S. et al. Single-cell spatial transcriptomics reveals a
 (2018). dynamic control of metabolic zonation and liver regeneration
54. Preibisch, S., Saalfeld, S. & Tomancak, P. Globally optimal by endothelial cell Wnt2 and Wnt9b. Cell Rep. Med. 3,
 stitching of tiled 3D microscopic image acquisitions. 100754 (2022).
 Bioinformatics 25, 1463–1465 (2009). 77. Petukhov, V. et al. Cell segmentation in imaging-based spatial
55. Klein, S., Staring, M., Murphy, K., Viergever, M. A. & Pluim, J. P. W. transcriptomics. Nat. Biotechnol. 40, 345–354 (2022).
 Elastix: a toolbox for intensity-based medical image registration. 78. Wahle, P. et al. Multimodal spatiotemporal phenotyping of human
 IEEE Trans. Med. Imaging 29, 196–205 (2010). retinal organoid development. Zenodo https://doi.org/10.5281/
56. van der Walt, S. et al. scikit-image: image processing in Python. zenodo.7561908 (2023).
 PeerJ. 2, e453 (2014). 79. Wahle, P. et al. Multimodal spatiotemporal phenotyping of human
57. Van Gassen, S. et al. FlowSOM: using self-organizing maps for retinal organoid development. Preprint at bioRxiv https://doi.org/
 visualization and interpretation of cytometry data. Cytometry A 10.1101/2022.03.16.484396 (2022).
 87, 636–645 (2015).
58. Levine, J. H. et al. Data-driven phenotypic dissection of AML Acknowledgements
 reveals progenitor-like cells that correlate with prognosis. We thank the Camp, Treutlein, Pelkmans and Institute of Molecular
 Cell 162, 184–197 (2015). and Clinical Ophthalmology Basel (IOB) laboratories for helpful

Article https://doi.org/10.1038/s41587-023-01747-2

discussions. P.W. is supported by the European Molecular S.P. generated the single-cell transcriptome and accessible chromatin
Biology Organization. G.B. is supported by the Peter und Traudl datasets. G.B. designed and performed the mosaic perturbation
Engelhorn-Stiftung. J.G.C., B.T. and L.P. are supported by CZF2019- and multiome experiments. C.H., P.W. and P.N. analyzed the 4i data.
002440 from the Chan Zuckerberg Initiative DAF, an advised fund G.G. and Z.H. gave feedback and suggestions on the analysis of the
of the Silicon Valley Community Foundation. J.G.C. is supported by 4i data. C.H. developed the Laminator and neighborhood analysis
the European Research Council (Anthropoid-803441) and the Swiss algorithms and performed related analysis, with the support of
National Science Foundation (project grant 310030_84795). B.T. is Z.H. and P.W. Z.H., Q.Y. and B.G. integrated and analyzed the
supported by the European Research Council (Organomics-758877 and developmental timecourse multimodal single-cell genomic data.
Braintime-874606), the Swiss National Science Foundation (project C.H. and Z.H. integrated 4i and single-cell genomic data to generate
grant 310030_192604) and the National Center of Competence in the digital retinal organoid. C.H. developed the web application
Research Molecular Systems Engineering. L.P. is supported by the EyeSee4is for visualization, with the support of P.W. J.S.F., Z.H. and
European Research Council (ERC-2019-AdG-885579), the Swiss G.B. analyzed the mosaic perturbation data. P.W. and G.B. prepared the
National Science Foundation (SNSF grant 310030_192622) and the tissues for Molecular Cartography; Z.H. and G.B. designed the gene
University of Zurich. J.S.F. is supported by the Boehringer Ingelheim list; and C.H. analyzed the data, with the support of Z.H. L.P., M.H. and
Fonds. We thank J. Jüttner and Ö. Keles for help with lentivirus G.G. provided training and intellectual guidance for the 4i experiments
preparation. Illumina sequencing was done by I. Nissen, E. Vogel and analyses. D.G., M.B., C.C., H.S. and B.R. collected the primary
Burcklen and C. Beisel of the Genomics Facility Basel, the Genomics human retina tissue. P.W., G.B., C.H., Z.H., B.T. and J.G.C. designed the
Core Facility (GeneCore) at EMBL Heidelberg, at the Single Cell study, interpreted results and wrote the manuscript.
Genomics Platform at IOB, Basel and at Novartis AG, NIBR, Chemical
Biology and Therapeutics (CBT) Genomic Sciences. FACS support was Funding
provided by M. Di Tacchio, A. Gumienny and T. Horn of the single-cell Open access funding provided by the University of Basel.
facility at D-BSSE, ETH Zurich. The Botond Roska laboratory, the Prisca
Liberali laboratory and the Lucas Pelkmans laboratory shared many Competing interests
antibody aliquots and/or tissue samples. We thank M. Zinner and The authors declare no competing interests.
U. Mayr for discussions of wet lab and analysis steps and S. Bichet and
A. Bogucki of the histology facility of the Friedrich Miescher Institute Additional information
for Biomedical Research for help with histology work and use of their Supplementary information The online version
instruments. We thank A. Ponti, E. Montani and T. Horn for assistance contains supplementary material available at
with microscopy, use of instruments and discussion of analysis steps. https://doi.org/10.1038/s41587-023-01747-2.

Author contributions Correspondence and requests for materials should be addressed to
G.B., M.R., Y.H., P.G. and A.S. generated organoids used in this study. Lucas Pelkmans, Barbara Treutlein or J. Gray Camp.
P.W. established, designed and performed the 4i experiments and
developed and performed the pre-processing of the data, with Peer review information Nature Biotechnology thanks Rong Fan
support from G.G., M.H., L.P. and P.N. T.T.A.L. and P.W. established the and the other, anonymous, reviewer(s) for their contribution to the
4i microscopy automation. G.S. and P.W. established the 4i staining peer review of this work.
automation. G.G. and J.S.C. developed the application of 4i on tissues
in multiwell plates including adaptations to the general 4i protocol, Reprints and permissions information is available at
the split-plate setup and the glass plate coating. G.B., A.S., D.P. and www.nature.com/reprints.

μ

μ μ
μ
