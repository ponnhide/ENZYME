Procedure
 CRITICAL TOBis MC can be used to assess organoids cultured in 6-, 12-, 48- or 96-well formats. This
 c

 protocol describes how to analyze intestinal organoids grown either in monoculture or co-cultured with
 intestinal ﬁbroblasts and/or primary bone marrow–derived macrophages in a 96-well plate. Users are
 advised to deploy their own optimized organoid culture conditions as inputs for TOBis MC.

 Culture organoids
 1 Culture organoids (or organoid co-cultures) in 50 µl of Matrigel and 200 µl of medium in a
 standard 96-well tissue culture plate.
 CRITICAL STEP For the results illustrated in this paper, we have cultured murine intestinal organoids

 c
 (Fig. 3), human CRC PDOs (Fig. 4) and murine organoids co-cultured with colonic ﬁbroblasts and/or
 macrophages (Fig. 5) for 3 d in 50 µl of Matrigel and 200 µl of medium. Users should use optimized
 culture conditions relevant to their own organoids and biological questions as inputs for TOBis MC.

 S phase cell labeling ● Timing ~30 min
 2 Add 127IdU directly to culture medium to a ﬁnal concentration of 25 µM (10 µl of 0.5 mM stock
 added to 200 µl of medium). Gently rotate the plate by hand ﬁve times for 10 s to mix the medium
 and incubate the plate for 25 min at 37 °C and 5% CO2.
 CRITICAL STEP 127IdU incubation enables identiﬁcation of S phase cells.
 c

 Phosphatase and protease inhibitor treatment ● Timing ~5 min
 3 Add the protease inhibitor cocktail (100× stock; see Reagents) and PhosSTOP (40× stock; see
 Reagents) directly to culture medium, gently rotate the plate by hand ﬁve times for 10 s and
 incubate for 5 min at 37 °C and 5% CO2.
 CRITICAL STEP Protease and phosphatase inhibitors have been shown to help preserve cell
 c

 signaling and antigen stability during ﬁxation28. However, because prolonged treatment may
 introduce technical artefacts, we advise users to empirically determine the duration of the treatment
 according to their experimental system and antibody panel (Supplementary Fig. 1).

 Fixation ● Timing ~80 min
 4 Remove culture medium by pipetting. Add 200 µl of prewarmed (37 °C) 4% (vol/vol) PFA into each
 well, taking care not to disrupt Matrigel. Incubate for 60 min at 37 °C and 5% CO2.
 CRITICAL STEP PFA ﬁxation in situ ensures that labile cell-state and PTM proﬁles are preserved
 c

 during the downstream sample handling.
 CRITICAL STEP Matrigel can dissolve in cold PFA. It is therefore important to prewarm PFA to 37 °C.
 c c

 CRITICAL STEP Some antibodies are sensitive to ﬁxation. PFA concentrations ranging from 1.6%
 to 4% were proved to be functional, but we encourage users to determine the optimal concentration
 of PFA for their speciﬁc antibody panel.
 ? TROUBLESHOOTING
 5 Remove PFA solution by pipetting, taking care not to disturb the Matrigel. Wash the cells with PBS
 on a rocker (speed set at ~45 rpm throughout the protocol) for 10 min at room temperature
 (~20 °C). Repeat the wash.
 PAUSE POINT Fixed cells can be kept at 4 °C in PBS. We advise users to determine the maximal
 j

 storage time with their speciﬁc culture systems.

 Live/dead discrimination ● Timing ~30 min
 6 Remove PBS by pipetting. Add 200 µl of 0.25 µM 194cisplatin/PBS solution to each well and
 incubate for 10–15 min on a rocker at room temperature.
 CRITICAL STEP Because dead cells can be found inside organoid structures (Fig. 1), it is crucial that
 c

 organoids be stained for long enough that all cells have the opportunity to bind cisplatin. However,
 organoids can also be easily overstained with cisplatin; it is therefore important that cultures are stained
 for the same duration of time and that this step does not exceed 20 min (Supplementary Fig. 2).
 7 Remove the 194cisplatin solution by pipetting. Wash cells with PBS on a rocker for 10 min at room
 temperature. Repeat the wash.
 CRITICAL STEP Proceed to the next steps on the same day. Long-term storage of cisplatin-
 c

 stained cells in situ will lead to cisplatin overstain that confounds live/dead cell discrimination.
 CRITICAL STEP If barcoding multiple organoid samples, continue to Step 8. If only one organoid
 c

 culture condition is being analyzed, skip to Step 11.

 TOBis (optional) ● Timing ~30 min of bench work; incubation overnight
 8 Transfer 200 µl of pre-aliquoted TOBis barcodes to corresponding organoid samples in a 96-well
 plate (from Step 7). Any barcode combination can be used to stain any culture condition
 (Supplementary Tables 3 and 4). Incubate the cells overnight at 4 °C.

PROTOCOL NATURE PROTOCOLS

 CRITICAL STEP Record the sample barcode assignments. Different samples labeled with the same

 c
 TOBis barcode should not be pooled together.
 CRITICAL STEP Ensure that correct amounts of TOBis barcode are added to each well for

 c
 successful debarcoding.
 CRITICAL STEP TOBis barcodes should not be used to stain >1 million cells per well of a 96-well

 c
 culture (Supplementary Fig. 3). In practice, culturing >1 million cells per well of a 96-well plate is
 uncommon. The users are advised to count cells at seeding if high-density cultures are needed.
 9 Remove the barcoding solutions by pipetting and wash the cells with 200 µl of 2 mM glutathione/
 CSB for 10 min on a rocker at room temperature. Repeat the wash twice.
 CRITICAL STEP Reduced glutathione quenches unused thiol-reactive TOBis barcodes, thereby
 c
 enabling efﬁcient discrimination of ‘on’ and ‘off’ signals for sample demultiplexing.
 10 Wash the cells with 200 µl of PBS for 10 min on a rocker at room temperature. Repeat the wash.
 PAUSE POINT The barcoded cells can be kept at 4 °C for ≤4 weeks in PBS.
 j

 Single-cell dissociation ● Timing ~90 min
 11 Make up a dissociation solution of fresh 0.5 mg/ml dispase II, 0.2 mg/ml collagenase IV and 0.2 mg/
 ml DNase I in PBS at room temperature.
 CRITICAL STEP Dissociation enzymes can affect cell recovery and antibody performance
 c

 (Supplementary Fig. 4). We encourage users to test and titrate alternative dissociation enzymes for
 the speciﬁc cellular composition of their experimental system.
 CRITICAL STEP Using freshly prepared enzyme solutions ensures optimal and reproducible
 c

 enzyme activity.
 12 Remove PBS from the wells by pipetting and add the dissociation solution.
 13 Scrape Matrigel droplets and pool all cells from all conditions with dissociation solution to a
 gentleMACS C-Tube. Top up the dissociation solution to 5 ml/C-Tube.
 CRITICAL STEP Do not overload the gentleMACS C-Tubes. We encourage users to empirically
 c

 determine how much dissociation buffer is needed on the basis of the density of their organoid
 cultures and the number of conditions. If multiple C-Tubes are needed, the user should pool all
 barcoded cells before splitting them evenly into each C-Tube to minimize technical variation.
 CRITICAL STEP Fibroblasts and leukocytes can migrate out of the central Matrigel droplet and
 c

 adhere to the plastic bottom of the culture plates in prolonged co-cultures. Scrape each well
 thoroughly to ensure that all cells are recovered.
 14 Dissociate organoids into single cells by using a gentleMACS Octo dissociator and the ‘Standard
 protocol’ (see Equipment setup) (Timing: ~50 min).
 CRITICAL STEP On completion of the program, the user needs to conﬁrm visually that the
 c

 dissociation is sufﬁcient; i.e., very few cell clumps should be visible at this stage. If not, users are
 encouraged to perform an additional round of the ‘Quick protocol’ (see Equipment setup) on the
 gentleMACS Octo dissociator.
 ? TROUBLESHOOTING
 15 After sufﬁcient dissociation, centrifuge the C-Tubes at 800g for 1 min at room temperature to
 collect the cells.
 16 Transfer all cells and solution to a polypropylene FACS tube.
 CRITICAL STEP Organoid cells often pellet better in polypropylene than polystyrene FACS tubes.
 c

 17 Centrifuge cells at 800g for 5 min at room temperature and discard the supernatant.
 18 Wash cells with 2 ml of CSB, centrifuge at 800g for 5 min at room temperature and discard the
 supernatant. Repeat the wash.
 19 Resuspend cells in 2 ml of CSB and ﬁlter through a cell strainer to get rid of residual cell clumps.
 CRITICAL STEP We use 35-µm cell strainers to ﬁlter organoid monocultures and 70-µm cell
 c

 strainers for cultures containing large cells such as ﬁbroblasts. Users should choose appropriate cell
 strainers on the basis of the cellular composition of their experimental system.
 20 Count cells by using the Countess II automated cell counter. Up to ~4.5 × 106 cells can be taken
 forward for 1× MC staining.
 PAUSE POINT The ﬁxed, barcoded and dissociated cells can be kept at 4 °C for ≤4 weeks in CSB.
 j

 ? TROUBLESHOOTING

 Extracellular stain ● Timing ~45 min
 21 Centrifuge cells at 800g for 5 min at room temperature, discard the supernatant and resuspend cells
 in 50 µl of CSB.

 22 Prepare extracellular antibody cocktail by mixing the antibody panel (see Supplementary Table 2
 for an example) at desired concentrations in CSB (total volume up to 50 µl).
 23 Add the extracellular antibody cocktail to the cells, mix thoroughly by pipetting and incubate for
 30 min on a rocker at room temperature.
 CRITICAL STEP Mix cells by gently ﬂicking the tube every 10 min to avoid cells pelleting under

 c
 gravity.
 24 Add 2 ml of CSB to the cells, centrifuge at 800g for 5 min at room temperature and discard the
 supernatant.

 Permeabilization ● Timing ~45 min
 25 Resuspend cells in 1 ml of 0.1% (vol/vol) Triton X-100/PBS, gently vortex and incubate for 30 min
 on a rocker at room temperature.
 CRITICAL STEP Mix cells by gently ﬂicking the tube every 10 min to avoid cells pelleting.
 c

 26 Add 2 ml of CSB to the cells, centrifuge at 800g for 5 min at room temperature and discard the
 supernatant. Repeat the wash and remove the supernatant.
 27 Place the cells on ice for 1 min.
 28 Resuspend cells in 1 ml of ice-cold 50% (vol/vol) methanol/PBS (store at −20 °C until use), gently
 vortex and incubate for 10 min on ice.
 CRITICAL STEP Different permeabilization buffers can substantially alter antibody staining
 c

 (Supplementary Fig. 5). Although we commonly use 0.1% (vol/vol) Triton X-100 followed by 50%
 (vol/vol) methanol, we advise users to optimize the permeabilization conditions that best suit their
 model system and antibody panel.
 29 Add 2 ml of CSB to the cells, centrifuge at 800g for 5 min at room temperature and discard the
 supernatant. Repeat the wash.
 30 Resuspend cells in 50 µl of CSB.

 Intracellular stain ● Timing ~45 min
 31 Prepare intracellular antibody cocktail by mixing the antibody panel (see Supplementary Table 2 for
 an example) at desired concentrations in CSB (total volume up to 50 µl).
 32 Add the intracellular antibody cocktail to the cells, mix thoroughly by pipetting and incubate for
 30 min on a rocker at room temperature.
 CRITICAL STEP Mix the cells by gently ﬂicking the tube every 10 min to avoid cells pelleting.
 c

 33 Add 2 ml of CSB to the cells, centrifuge at 800g for 5 min at room temperature and discard the
 supernatant.

 Post-staining ﬁxation ● Timing ~15 min
 34 Add 1 ml of 1.6% (vol/vol) FA/PBS solution made fresh from 16% (vol/vol) FA to the cells and
 incubate for 10 min on a rocker at room temperature.
 CRITICAL STEP The post-staining ﬁxation step is required if the sample needs to be stored for
 c

 >48 h before data acquisition.
 35 Add 2 ml of CSB to the cells, centrifuge at 800g for 5 min at room temperature and discard the
 supernatant.

 DNA intercalation ● Timing ~1 h/overnight
 36 Prepare intercalation buffer by diluting 1 µl of 125 µM Cell-ID Intercalator-Ir in 1 ml of Fix & Perm
 buffer (ﬁnal concentration = 125 nM).
 37 Resuspend cells in 1 ml of intercalation buffer, gently vortex and incubate for 1 h on a rocker at
 room temperature or overnight at 4 °C.
 CRITICAL STEP Because the intercalation reaction is non-covalent, cells should be kept at 4 °C in
 c

 the intercalation buffer until ready to proceed to data acquisition (e.g., when the Helios is tuned).
 PAUSE POINT Cells can be stored at 4 °C in the intercalation buffer for ≤2 weeks (with post-
 j

 staining ﬁxation) or 48 h (without post-staining ﬁxation).

 MC data acquisition ● Timing ≥1 h (dependent on the scale of the experiment)
 38 Tune the Helios mass cytometer (see Equipment setup).
 CRITICAL STEP A reproducible tuning procedure ensures predictable ‘on’ and ‘off’ intensities of
 c

 the TOBis barcode channels.

PROTOCOL NATURE PROTOCOLS

 CRITICAL STEP For prolonged MC runs (e.g., when the acquisition lasts for >4 h), we advise

 c
 users to perform the ‘Quick Tuning Protocol’ implemented in the Fluidigm CyTOF software to
 ensure consistent signal intensity within the same experiment.
 39 Centrifuge cells at 800g for 5 min at room temperature and discard the supernatant.
 40 Wash the cells with 2 ml of of 2 mM EDTA/CSB, centrifuge at 800g for 5 min at room temperature
 and discard the supernatant.
 CRITICAL STEP EDTA chelates free metals in the cell suspension and can clean up MC data

 c
 acquisition. Do not exceed 2 mM EDTA.
 41 Wash cells with 2 ml of CSB, centrifuge at 800g for 5 min at room temperature and discard the
 supernatant.
 42 Wash cells with 2 ml of MaxPar water, centrifuge at 800g for 5 min at room temperature and
 discard the supernatant.
 43 Resuspend cells in 1 ml of MaxPar water, ﬁlter through a 35-µm cell strainer (70 µm
 when the culture contains ﬁbroblasts) and count the cells by using a Countess II automated
 cell counter.
 44 Dilute cells to ~0.8–1.2 × 106/ml in MaxPar water.
 45 Add EQ beads to the cell suspension at a volumetric ratio of 1:5.
 46 Add EDTA to the cells to a ﬁnal concentration of 2 mM.
 CRITICAL STEP EDTA reduces cell clumps during data acquisition.
 c

 47 Set up the ‘Super Sampler’ (Victorian Airships) as per the manufacturer’s instructions, and
 set up acquisition parameters (e.g., antibody panel and experiment metadata) on the
 Helios mass cytometer.
 CRITICAL STEP To avoid blockage and ensure smooth data acquisition, we advise users to use the
 c

 ‘Super Sampler’ to load organoid cells/ﬁbroblasts to the Helios mass cytometer.
 48 Acquire events on the Helios mass cytometer by using the Fluidigm CyTOF software. Aim for
 100–400 events/s.
 49 After all events are acquired, process the raw data by using the Fluidigm CyTOF software as per
 Fluidigm’s recommendation (i.e., signal normalization, removal of EQ beads and concatenation of
 data ﬁles if needed). Export data as FCS ﬁle(s) (Fig. 6a, Raw.fcs).
 ? TROUBLESHOOTING

 Debarcoding the TOBis multiplexed MC dataset ● Timing ~15 min
 50 Debarcode multiplexed FCS ﬁle(s) (Fig. 6a, Raw.fcs) into separate experimental conditions by using
 the MATLAB program Zunder Lab Single Cell Debarcoder (https://github.com/zunderlab/single-
 cell-debarcoder)44 with user-deﬁned TOBis barcode keys (Supplementary Tables 3 and 4).
 ? TROUBLESHOOTING

 Installation of CyGNAL ● Timing ~20 min
 51 Download the CyGNAL v0.2.1 from the GitHub repository (https://github.com/TAPE-Lab/
 CyGNAL/releases/tag/v0.2.1) and open a terminal session from the repository folder (/CyGNAL-
 0.2.1, hereafter referred to as ‘pipeline folder’).
 52 Set up the computing environment (see Software). We recommend using Conda (https://docs.
 conda.io/projects/conda/en/latest/index.html) to recreate the environment deﬁned in conda_env.
 yml by running the following from the pipeline folder:

 conda env create -f conda_env.yml
 conda activate cygnal

 CRITICAL STEP All required libraries need to be installed at the recommended versions for
 c

 successful execution of the pipeline (see Software).
 ? TROUBLESHOOTING

 Single-cell organoid data preprocessing ● Timing ~45 min
 53 Import debarcoded FCS ﬁles to the Cytobank platform (http://www.cytobank.org/) or an equivalent
 FCS processing software (e.g., FlowJo).
 54 Perform Gaussian gating to remove debris (Fig. 6b).
 55 Perform DNA/cisplatin gating to identify cells (Fig. 6b).

 CRITICAL STEP Different cell types may display distinct abundances of DNA. Users are advised

 c
 to check every experimental condition to ensure that all cell types of interest are included in the
 DNA gating step.
 CRITICAL STEP The cisplatinhigh population contains both dead and dying cells. If cell death is of

 c
 biological interest (e.g., in a drug-screening assay), we suggest users be more lenient with the
 cisplatin gating to include dying cells.
 56 Perform cell-type gating to exclude doublets (i.e., cells positive for mutually exclusive cell-type
 markers) (Fig. 6b).
 57 Export the dataset as FCS ﬁles and proceed to data analysis with CyGNAL.
 CRITICAL STEP The dataset now contains events that are identiﬁed as single cells (Fig. 6b,
 c
 TOBis_n_Cells.fcs).
 58 To preprocess dataset(s) by using CyGNAL, copy the cell-comprised FCS ﬁle(s) to the Raw_Data
 folder within the pipeline folder, run python code/1-data_preprocess.py and follow the
 prompts. This step will generate two outputs: the preprocessed datasets and the ﬁle
 panel_markers.csv containing all the markers used in the experiment. The output ﬁles are
 saved in a folder named by the user-deﬁned analysis identiﬁer within the Preprocessed_Data folder
 (Fig. 6b and Supplementary Fig. 6).
 CRITICAL STEP Preprocessing of dataset(s) by 1-data_preprocess.py is prerequisite for the
 c

 subsequent analysis steps and has to be performed as the ﬁrst step of the workﬂow.
 CRITICAL STEP panel_markers.csv is used by downstream scripts to specify the markers of
 c

 interest in a given analysis.
 CRITICAL STEP The input ﬁle formats supported by CyGNAL are standard FCS and tab-
 c

 separated ASCII TXT. Users can choose to save the output as either TXT or FCS ﬁle(s) (stripped of
 original FCS metadata), with the default set to match the input ﬁle format (example ﬁles can be
 accessed at the GitHub repository).

 Dimensionality reduction (UMAP) ● Timing 20–40 min (~1 million cells)
 59 Copy CyGNAL-processed dataset(s) and the corresponding panel_markers.csv to the Analysis/
 UMAP_input/ folder and edit panel_markers.csv by labeling markers used for UMAP calculation
 with ‘Y’ (by default, all markers are labeled with ‘N’).
 60 Run python code/2-umap.py from the pipeline folder and follow the prompts. The original
 dataset updated with UMAP coordinates will be formatted as TXT ﬁle(s) and saved in a folder
 named by the user-deﬁned analysis identiﬁer in Analysis/UMAP_output/ (Fig. 6c and
 CRITICAL STEP When performing UMAP analysis on multiple conditions within the same
 c

 experiment, the 2-umap.py script will concatenate all the input ﬁles, calculate UMAP coordinates
 for the concatenated dataset and save the results as separate conditions on the basis of their ﬁle of
 origin. This ensures that all the input ﬁles share a common UMAP embedding to facilitate direct
 comparison between conditions.
 CRITICAL STEP When multiple ﬁles are used for UMAP analysis, users can down-sample all
 c

 input ﬁles to the cell count of the sample with the lowest cell number (details on which cells are
 included for the analysis can be found in the output folder). This yields a more balanced dataset for
 UMAP calculation and visualization and reduces memory requirements and computation time.

 Cell-type and cell-state identiﬁcation ● Timing ~45 min
 61 Import CyGNAL-processed dataset(s) to Cytobank or an equivalent FCS processing
 software (e.g., FlowJo).
 62 Identify different cell types present in the experimental condition(s) on the basis of cell
 type–speciﬁc markers (Fig. 6d).
 CRITICAL STEP To improve the ﬁdelity of cell-type identiﬁcation, at least two markers should be
 c

 used per cell type. Ectopically expressed cell type–speciﬁc ﬂuorescent proteins such as GFP and RFP
 are useful for cell-type identiﬁcation when robust endogenous antigens are unavailable.
 63 For each identiﬁed cell type, perform cell-state analysis based on cell-state markers (Fig. 6e).
 64 Export the cell type– and/or cell state–speciﬁc dataset(s) as FCS or TXT ﬁles for PTM signaling
 network analysis.
 CRITICAL STEP If using Cytobank, uncheck ‘Include header with FCS ﬁlename’ when exporting
 c

 TXT ﬁles and make sure that the dataset(s) is exported as raw values (Cytobank gives users the
 option to export illustration-based transformed data).

PROTOCOL NATURE PROTOCOLS

 PTM signaling network analysis ● Timing 20–40 min (dependent on the scale of the
 experiment)
 65 Copy CyGNAL-processed, cell type–speciﬁc dataset(s) and the corresponding panel_markers.csv to
 Analysis/EMD_input/ or Analysis/DREMI_input/ and edit panel_markers.csv by labeling markers
 used for the calculation with ‘Y’ (by default, all markers are labeled with ‘N’).
 66 Run python code/3-emd.py or python code/4-dremi.py and follow the prompts. The
 output will be saved in folders named by the user-deﬁned analysis identiﬁer within Analysis/
 EMD_output/ or Analysis/EMD_output/ accordingly. EMD and DREMI scores can be visualized
 by using heatmaps (Steps 67 and 68) or summarized with PCA (Steps 69 and 70).
 CRITICAL STEP For EMD calculations, the user needs to deﬁne the reference (R) dataset for all
 c
 experimental variables (V) against which to compare. By default, the concatenation of all input ﬁles
 is used as R, but users can also assign a speciﬁc dataset as the reference.
 CRITICAL STEP The choice of R can greatly inﬂuence the interpretation of EMD scores. When
 c

 there is a clear baseline control in a given experiment (e.g., untreated monoculture), that control
 population should be used as R. However, when there is no obvious baseline condition (e.g., when
 comparing PTMs between different cell types within organoids), we advise using a concatenated
 population of all conditions as R (default setting).
 CRITICAL STEP EMD is a non-negative metric quantifying the difference between two
 c

 distributions. In our workﬂow, EMD scores are signed by the difference of a marker’s median
 intensity between V and R to indicate the ‘direction’ of signaling change—positive for up-regulation
 and negative for down-regulation.
 CRITICAL STEP For DREMI calculations, users can perform standard deviation–based outlier
 c

 removal or generate conditional probability plots for each marker combination. Note: these
 optional settings increase computational load.

 Heatmap visualization ● Timing <5 min
 67 To visualize EMD/DREMI scores by using heatmaps, copy the output of EMD/DREMI calculations
 to the Analysis/Vis_Heatmap folder.
 68 Open a terminal from the pipeline folder, run python code/5v1-heatmap.py and perform
 interactive heatmap visualization in the prompted browser window. Once a satisfactory layout has
 been achieved, the heatmaps can be exported as a PNG image or PDF document.

 PCA ● Timing <5 min
 69 To perform PCA, copy the output of EMD/DREMI calculations to the Analysis/Vis_PCA folder.
 70 Run python code/5v2-pca.py and perform interactive heatmap visualization in the
 prompted browser window. Once a satisfactory layout has been achieved, the heatmaps can be
 exported as a PNG image or PDF document. The PCA coordinates with the percentage of variance
 explained by each principal component can be exported separately as a TXT ﬁle.

Troubleshooting
Troubleshooting advice can be found in Table 1.

 Step Problem Possible reason Solution

 4 Matrigel droplets dissolve in PFA The PFA solution is not warm enough Prewarm 4% (vol/vol) PFA solution to 37 °C before
 the ﬁxation step. Be careful not to disturb the Matrigel
 droplets when adding PFA to the wells
 14 Organoids are not dissociated gentleMACS C-Tubes are overloaded, or In our experience, up to ~5 × 106 cells per C-Tube can
 properly the dissociation enzymes are performing be dissociated sufﬁciently by using our custom
 at suboptimal activity dissociation program. We recommend that users
 prepare fresh dissociation solution before each use.
 Run additional rounds of the ‘Quick Protocol’ if needed

 Step Problem Possible reason Solution

 20 Considerable cell loss, especially Cell loss is inevitable during staining We recommend that users start with >1 × 106 cells in
 after being transferred to a new because of the multiple washing steps, and total, barcode cells and pool different conditions as
 FACS tube it is more striking with fewer cells. In early as possible during the protocol (that is part of the
 particular, when cells are centrifuged in motivation of the development of TOBis). In addition,
 uncoated polypropylene FACS tubes, a during optimization, we observed that coating
 thin ﬁlm of cells will form on the side of polypropylene FACS tubes with CSB before
 the tube instead of a well-deﬁned cell centrifugation of cells resuspended in PBS also
 pellet, leading to further cell loss facilitates the cells spinnig down properly and thereby
 increases cell recovery
 49 Antibody staining is not working The antibody needs to be titrated, or Antibody panels for MC experiments need to be
 alternative antibodies/clones need to carefully designed and titrated in accordance with
 be tested known impurities and antigen abundance55,56. We also
 encourage users to test alternative ﬁxation and
 permeabilization conditions for their speciﬁc
 experimental system
 50 Experimental conditions are not Incorrect amounts of barcodes are added Ensure that barcodes are accurately divided into
 debarcoded efﬁciently to the cells aliquots and that all barcodes from each TOBis
 condition are added to the cell cultures
 The MC run acquires heavy metal Adding 2 mM EDTA to the CSB wash buffer before MC
 contaminants accumulated during the data acquisition helps chelate free metals in the cell
 staining steps, causing a lower-than- suspension and clean up the MC run
 expected percentage of ‘real’ events
 An incompatible barcode key is provided Make sure that the correct barcode key is used for
 to the Debarcoder debarcoding a speciﬁc experiment
 52 Error messages when installing Python or R package(s) failed to be Identify missing package(s) (see error information of
 Conda environment or running installed in the Conda environment at the conda env setup or run a pipeline script and check
 pipeline scripts recommended versions which python import fails). Manually install the
 package(s) per their speciﬁc instructions
 Errors in R installation are probably caused by missing
 compilation tools in the operating system (macOS in
 particular). Identify the missing tools and manually
 install them. Execution of 5v1-emd_dremi_htmp.py or
 5v2-pca.py should also trigger automatic installation of
 any missing R packages
 Refer to the GitHub issue page for additional help

Timing
 Steps 2–5, Pretreatment and ﬁxation of organoids: ~2 h
 Steps 6 and 7, live/dead discrimination staining: ~0.5 h
 Step 8, TOBis barcoding: 1–2 h at room temperature or overnight at 4 °C
 Steps 9 and 10, quenching of TOBis barcodes: ~0.5 h
 Steps 11–20, single-cell dissociation: 1–2 h
 Steps 21–35, MC staining: ~2.5 h
 Steps 36 and 37, DNA intercalation: 1 h at room temperature or overnight at 4 °C
 Steps 38–49, data acquisition: 1–2 h, depending on the number of cells to be analyzed
 Steps 50–70, data analysis: 2–4 h, depending on the scale of the experiment

Anticipated results
 This TOBis MC protocol typically generates >1,000,000 single-cell measurements of ~50 MC
 channels (cell-type identiﬁcation antibodies, cell-state antibodies/probes and PTM antibodies) from
 up to 126 organoid cultures (Fig. 3d). When compared with the starting cell count (i.e., after single-
 cell dissociation), 50–60% of the cells can be acquired by MC, and the sum of TOBis_n_Cells.fcs cell
 counts typically ranges from 50% to 70% of the total debarcoded event count. Previous analysis with
 small intestinal organoids conﬁrmed that cell-type and cell-state recovery was in line with expected
 ratios for small intestinal epithelia17. The standard output ﬁles generated by the workﬂow are for-
 matted as FCS 3.0, which is compatible with third-party cytometry data analysis tools including
 Cytobank and FlowJo, where manual data preprocessing, cell-type identiﬁcation and cell-state

PROTOCOL NATURE PROTOCOLS

 classiﬁcation can be performed. We do not routinely perform compensation58 or batch correction59
 on TOBis MC data, but such strategies could be useful for some users. Single-cell data can be
 visualized by using UMAP50 via CyGNAL (or t-SNE (t-distributed stochastic neighbor embedding)60/
 PHATE (potential of heat diffusion for afﬁnity-based trajectory embedding)61 by using standalone
 scripts), and cell type–speciﬁc organoid PTM network analysis is performed with EMD51,52 (node)
 and DREMI53 (edge) scoring. EMD and DREMI scores output to .csv format and can be easily
 visualized by using heatmaps and PCA. The cell type–speciﬁc results generated by this TOBis MC
 protocol can be used to quantitively compare cell states and PTM signaling networks between
 organoids and organoid co-cultures.

 Reporting Summary
 Further information on research design is available in the Nature Research Reporting Summary
 linked to this article.
