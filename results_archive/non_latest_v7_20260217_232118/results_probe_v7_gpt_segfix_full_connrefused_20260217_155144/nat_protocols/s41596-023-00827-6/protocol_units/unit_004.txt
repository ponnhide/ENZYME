Procedure
 1 Remove the insert from the 24-well plate, invert it and gently peel off the membrane from the bottom of the insert using forceps.
 2 Carefully place the insert with the membrane removed over the mouth of an open, empty 15 ml centrifuge tube.
 3 Add 1 ml of cell recovery reagent to the insert such that the embedded organoid with Matrigel falls into the 15 ml centrifuge tube.
 4 Close the 15 ml centrifuge tube and immediately place on ice to depolymerize the Matrigel.
 5 Every 20 min, gently shake the tube to check if the Matrigel has dissolved and place it back on ice.
 6 Once the Matrigel has dissolved, add 10 ml of wash medium to the tube. Time varies from ~45 min to 1 h depending on Matrigel thickness.
 7 Centrifuge at 200g for 5 min.
 8 Aspirate the wash medium and cell recovery reagent and add 1 ml of Accutase to the organoid and incubate at 37 °C.
 CRITICAL STEP Avoid using trypsin to dissociate the organoid as it is too harsh and the chances of losing fragile cell types is higher.
 c

 9 Gently shake the tube to disturb/dissociate the organoid every 5 min and replace the tube at 37 °C for 10–12 min. Time varies depending on the
 organoid size and density.
 10 When the organoid is dissociated add 10 ml wash medium and centrifuge at 400g for 4 min.
 11 Aspirate the wash medium and resuspend the pellet in base medium.
 CRITICAL STEP Check the base medium compatibility with the sequencing technology to be used for scRNAseq.
 c

 12 Remove dead cells from the cell suspension by using the MiltenyiBiotec dead cell removal kit.
 13 Dilute the cell suspension to a concentration of 5,000 cells/μl for sequencing. For sequencing and analysis of scRNAseq data, see Box 3.
 CRITICAL STEP Cell suspension dilution varies depending on the sequencing vendor requirements.
 c

 ● CD184 (CXCR4) MicroBead Kit, human (Miltenyi Biotec, cat. no. 130-100-070)
 ● Dimethyl sulfoxide (DMSO) (Fisher, cat. no. BP231-100)

 Equipment
 ● 10 cm2 tissue-culture dish (BD Falcon, cat. no. 353003)
 ● 15 ml conical tube (BD Falcon, cat. no. 352097)
 ● 50 ml conical tube (BD Falcon, cat. no. 352098)

 ● Posi-Click 1.7 ml microcentrifuge tube (Denville, cat. no. C2170)

 CRITICAL Inserts from BD Falcon hold more
 c

 ● 24-Well transwell insert (BD Falcon, cat. no. 8770)

 medium in the inserts than other brands tested. This will result in better organoid morphology.
 ● 24-Well ﬂat-bottom tissue culture-treated plate (Falcon, cat. no. 353047)

 ●
 24-Well ﬂat-bottom not treated cell culture plate (Falcon, cat. no. 351147)
 ● Six-well ultralow-attachment plate (Costar, cat. no. 3471)

 ● Six-well ﬂat-bottom tissue culture-treated plate (Falcon, cat. no. 353046)

 ● 96-Well U-bottom non-tissue culture-treated plate (Corning, cat. no. 351177)

 ● P10 barrier tips (Denville Scientiﬁc, cat. no. P1096-FR)

 ● P20 barrier tips (Denville Scientiﬁc, cat. no. P1121)

 ● P200 barrier tips (Denville Scientiﬁc, cat. no. P1122)

 ● P1000 barrier tips (Denville Scientiﬁc, cat. no. P1126)

 ● Serological pipets, individually wrapped, 5 ml (Fisher, cat. no. 13-678-11D)

 ● Serological pipets, individually wrapped, 10 ml (Fisher, cat. no. 13-678-11E)

 ● Serological pipets, individually wrapped, 25 ml (Fisher, cat. no. 13-678-11)

 ●
 Disposable sterile bottle-top ﬁlters (Corning, cat. no. 431118)
 ● Disposable sterile bottles, 250 ml (Corning, cat. no. 430281)

 ● Disposable sterile bottles, 500 ml (Corning, cat. no. 430282)

 ● Disposable sterile bottles, 1,000 ml (Corning, cat. no. 430518)

PROTOCOL NATURE PROTOCOLS

 a 6 d25 d40 d60 d80
 b %
 d80 0
 20
 9 6 9 6
 6 9 6 2 40
 9
 3 2 2

 Identity
 2 d60 60
 Umap_2

 80
 8 8
 8 0 7 8 0 0 7 d40
 0 7 5 0 7 5 Expre-
 5 ssion
 5
 1.0
 0.5
 1 1 1 d25 0
 –0.5
 1 –1.0
 –3 3 4 4
 3 3 4
 3 4

 1

 1
 PM

 AB B

 N 3
 SL PSA

 LP 2

 G 1
 A2

 G 2
 A4

 C Y1
 A2

 B1

 X4

 B
 67

 2
 XA

 2.

 T
 A

 DX

 TA
 A
 TP

 T2
 A

 TH

 ZE

 Ki
 43

 B3

 L1
 KX

 TB
 C

 AT
 C

 C
 FO

 N
 SF

 AC
 A

 C

 O
 C

 W
 N

 SC
 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4
 Umap_1 Features

 c 6
 d25 d40 d60
 6
 d80 d25 d40 d60 d80
 6 6 6 6 6 6
 6 9 6 9 6 9 6 2 6 9 6 9 6 9 6 2
 3 9 3 2 3
 9 2
 2 2 3 3 2 3 2 3 3
 8 8 8 8
 FOXA1

 CDX2
 0 8 0 7 0 8 0 7 0 0 7 5 0 0 7 5 0
 8 0 7 0
 8 0 7 0 0 7 5 0 0 7 5
 5 5 5 5
 1 1 1 1 1 1 1 1
 –3 3 4 –3 –3 –3 3 –3 3 4 –3 –3 –3 3
 3 4 4 3 4 2 3 4 4 3 4 2
 3 1 3 1
 0 0
 –6 –6 –6 –6 –6 –6 –6 –6
 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4
 6 6 6 6 6 6 6 6
 6 9 6 9 6 9 6 2 6 9 6 9 6 9 6 2
 9 9 2
 3 2 3 2 3 2 3 3 2 3 2 3 3

 GATA4
 8 8 8 8
 NKX2.1

 0
 8 0 7 0
 8 0 7 0 0 7 5 0 0 7 5 0
 8 0 7 0
 8 0 7 0 0 7 5 0 0 7 5
 5 5 5 5
 1 1 1 1 1 1 1 1
 –3 1.6
 –3 3 4 –3 –3 –3 3 –3 3 4 –3 4 –3
 3 4 4 3 4 2 3 3 4 3 4 1.2
 3 1
 0.8
 0.4
 0 0
 –6 –6 –6 –6 –6 –6 –6 –6
 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4
 6 6 6 6 6 6 6 6
 6 9 6 9 6 9 6 6 9 6 9 6 9 6 2
 9 2 9 3 2
 3 2 3 2 3 2 3 3 2 3 2 3
 8 8 8 0 7 8 8
 8 0 7 0 8 0 7 0 7 0 8 0 7 0 7
 CPM

 THY1

 0 5 0 5 0 0 7 5 0 5 0 5 0 0 7 5
 5 5
 1 1 1 1 1 1 1
 –3 –3 –3 1 –3 –3 –3 –3 –3 3
 3 4 3 4 3 4 3 3 4 3 4 3 4 2
 3 4 2
 1 3 4 1
 0 0
 –6 –6 –6 –6 –6 –6 –6 –6
 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4
 6 6 6 6 6 6 6 6
 6 9 6 9 6 9 6 6 9 6 9 6 9 6 2
 9 2 9 3 2
 3 2 3 2 3 2 3 3 2 3 2 3
 COL1A2

 8 8 8 0 7 8 8 8
 0 7
 SFTPB

 0 8 0 8 0 7 0 0 7 0 0 7 5 0 0 0 7 0 0 7 5 0 0 7 5
 5 5 5 5 5
 1 1 1 1 1 1 1
 –3 –3 –3 1 –3 –3 –3 –3 –3
 3 4 3 4 3 4
 4
 3 3 4 3 4 3 4 4
 3
 3 4 2 3 4 2
 1
 1 0
 0 –6
 –6 –6 –6 –6 –6 –6 –6
 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4

 6 6 6 6 6 6 6 6
 6 9 6 9 6 9 6 6 9 6 9 6 9 6 2
 9 2 9 3 2
 3 3 2 3 2 3 3 2 3 2 3
 2
 8 8
 ABCA3

 0 7 8 8 8 0 7 8 0 7
 8 0 8 0 7 0 7 0 7 0 7
 ZEB1

 0 0 5 0 0 7 5 0 0 5 0 5 0 5
 5 5 5
 1 1 1 1 1 1 1
 –3 –3 –3 1 –3 –3 3 4 –3 –3 –3 3
 3 4 3 4 3 4 3 3 4 4 3 4 2
 3 4 2
 1
 3 1
 0 0
 –6 –6 –6 –6 –6 –6 –6 –6
 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4

 6 6 6 6 6 6 6 6
 9 6 9 6 6 9 6 9 6 9 6 2
 9 6 9 6 2 9 3 2
 3 3 2 3 2 3 3 2 3 2 3
 2
 8 8
 NAPSA

 8 8 8 0 7 8
 TBX4

 8 0 7 0 8 0 7 0 7 0 7 0 0 7 0 7 5
 0 5 0 5 0 0 7 5 0
 5 0 5 5 0
 5
 1 1 1 1 1 1 1
 –3 –3 –3 1 –3 –3 3 4 –3 –3 –3 2.0
 3 4 3 4 3 4 3 3 4 4 3 4 1.5
 3 4 2
 1
 3 1.0
 0.5
 0
 –6 –6 –6 –6 0 –6 –6 –6 –6
 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4

 6 6 6 6 6 6 6 6
 9 9 6 6 9 6 9 6 9 6 2
 9 6 6 9 6 2 9 3 2
 3 2 3 2 3 2 3 3 2 3 2 3
 SLC34A2

 WNT2B

 8 8 8 0 7 8 0 7 8 8
 0
 8 0 7 0 8 0 7 0 0 7 0 0 7 5 0 0 5 0 0 7 5 0 0 7 5
 5 5 5 5
 1 1 1 1 1 1
 1 1 –3 –3 –3 –3 3
 –3 3 4 –3 4
 –3 –3 3 3 4 3 4 3 4 2
 3 3 4 3 4 2 3 4 1
 1 0
 –6 –6 –6 –6
 0 –6 –6 –6 –6
 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4

 6 6 6 6 6 6 6 6
 6 9 6 9 6 9 6 6 9 6 9 6 9 6 2
 9 2 9 2
 3 2 3 2 3 2 3 3 2 3 2 3 3
 ACTA2

 8 8 8 8
 LPCAT1

 0
 8 0 7 0
 8 0 7 0 0 7 0 0 7 5 0
 8 0 7 0
 8 0 7 0 0 7 5 0 0 7 5
 5 5 5 5 5
 1 1 1 1 1 1 1
 –3 –3 –3 1 –3 –3 –3 –3 3
 3 4 3 4 –3
 3 4 3 3 4 3 4 3 4 2
 3 4 2
 1
 3 4 1
 0 0
 –6 –6 –6 –6 –6 –6 –6 –6
 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4

 6 6 6 6 6 6 6 6
 6 9 6 9 6 9 6 6 9 6 9 6 9 6 2
 9 2 9 3 2
 3 2 3 2 3 2 3 3 2 3 2 3
 SCGB3A2

 8 8 8 0 7 8 8 8
 8 0 7 0 8 0 7 0 7 0 7 0 7
 Ki67

 0 5 0 5 0 0 7 5 0 0 5 0 5 0 0 7 5
 5 5
 1 1 1 1 1 1 1
 –3 –3 –3 1 –3 –3 –3 –3 –3 4
 3 4 3 4 3 4 3 3 4 3 4 3 4 3
 3 4 2
 1
 3 4 2
 1
 0 0
 –6 –6 –6 –6 –6 –6 –6 –6
 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4 –8 –4 0 4

dynamic expression of endodermal (FOXA1), lung (NKX2.1, CPM), distal lung (SFTPB, NAPSA, SLC34A2, LPCAT), distal airway (SCGB3A2), mid and
hindgut (GATA4, CDX2), mesenchymal (THY1, COL1A2, ZEB1, TBX4, WNT2B), proliferating cell (Ki67) and housekeeping genes (ACTA2) genes over
time. c, UMAP feature plots of genes shown in b.

 ● Fluorescence-activated cell sorting (FACS) tube (BD Falcon, 352008 or Corning, cat. no. 352008)
 ● Round-bottom polystyrene test tubes with cell strainer snap cap (BD Falcon, cat. no. 352235 or
 Corning, cat. no. 352235)
 ● Tissue culture hood

 ● Normoxic incubator (95% air/5% CO /37 °C)
 2
 ●
 Hypoxic incubator (5% O2/5% CO2/37 °C)
 ●
 Centrifuge
 ● Hemocytometer

 ● Picking hood

 ● Microscopes: dissecting microscope: Nikon SMZ1500; laser scanning confocal microscope: Leica TCS

 SP8 Stellaris (40× oil immersion objective); Leica DMi1 Inverted Phase Contrast Microscope (Hi Plan
 4×, Phase Contrast Hi Plan 10× Ph1 and 20× Ph1) CRITICAL Similar microscopes from other

 c
 manufacturers can be used.
 ● Pipettes

 ● Pipet aid

 ● FlowJo ﬂow cytometry software (https://www.ﬂowjo.com/solutions/ﬂowjo (RRID: SCR_008520))

 Reagent setup
 Growth factors and small molecules
 FGF2
 Reconstitute at 20 μg/ml in sterile 0.1% BSA/DPBS (wt/vol). Aliquot 100 μl to 500 μl in micro-
 centrifuge tubes. Aliquots can be stored at −20 °C to −70 °C for up to 3 months.
 FGF10
 Reconstitute at 10 μg/ml in sterile 0.1% BSA/DPBS (wt/vol). Aliquot 500 μl in microcentrifuge tubes.
 Aliquots can be stored at −20 °C to −70 °C for up to 3 months.
 FGF7
 Reconstitute at 10 μg/ml in sterile 0.1% BSA/DPBS (wt/vol). Aliquot 500 μl in microcentrifuge tubes.
 Aliquots can be stored at −20 °C to −70 °C for up to 3 months.
 BMP4
 Reconstitute at 10 μg/ml in sterile 0.1% BSA/DPBS (wt/vol). Aliquot 500 μl in microcentrifuge tubes.
 Aliquots can be stored at −20 °C to −70 °C for up to 3 months.
 CHIR 99021
 Reconstitute at 3 mM in DMSO. Aliquot 100 μl in microcentrifuge tubes. Aliquots can be stored at
 −20 °C to −70 °C for up to 6 months.
 All-trans RA
 Reconstitute at 50 μM in DMSO. Aliquot 100 μl in microcentrifuge tubes. Aliquots can be stored at
 −20 °C to −70 °C for up to 3 months.
 IWP2
 Reconstitute at 1 mM in DMSO. Aliquot 100 μl in microcentrifuge tubes. Aliquots can be stored at
 −20 °C to −70 °C for up to 6 months.
 Noggin
 Reconstitute at 100 μg/ml in sterile 0.1% BSA/DPBS (wt/vol). Aliquot 100 μl in microcentrifuge tubes.
 Aliquots can be stored at −20 °C to −70 °C for up to 3 months.
 SB431542
 Reconstitute at 10 mM in DMSO. Aliquot 100 μl in microcentrifuge tubes. Aliquots can be stored at
 −20 °C to −70 °C for up to 6 months.
 Y-27632
 Reconstitute at 10 mM in DMSO. Aliquot 100 μl in microcentrifuge tubes. Aliquots can be stored at
 −20 °C to −70 °C for up to 6 months.
 Activin A
 Reconstitute at 100 μg/ml in sterile 0.1% BSA/DPBS (wt/vol). Aliquot 100 μl in microcentrifuge tubes.
 Aliquots can be stored at −20 °C to −70 °C for up to 3 months.

PROTOCOL NATURE PROTOCOLS

 a 15 FOXA1 15
 NKX2.1 15 CPM 15
 SFTPB 15 ABCA3 15 NAPSA
 12 12 12

 10
 12
 d25 10
 12

 10 10
 12

 10 10
 d80
 UMAP_2

 UMAP_2

 UMAP_2

 UMAP_2

 UMAP_2

 UMAP_2
 13 0 13 0 13 0
 5 3
 13
 11
 0 5
 5 3
 13
 11
 0 5 5 3 11
 5
 4
 5 3
 13
 11
 0 5 5 3 11
 5
 4
 5 3 11
 5
 4
 6 8 1 4 6 8 1 4 6 8 1 6 8 1 4 6 8 1 6 8 1
 17 3 17 3 17 3 17 3 17 3 17 3
 0 10 2 0 10 2 0 10 2 0 10 2 0 10 2 0 10 2
 16 1 16 1 16 1 16 1 16 1 16 1

 –5 4
 9
 5 14 –5 4
 9
 5 14 –5 4
 9
 5 14 –5 4
 9
 5 14 –5 4
 9
 5 14 –5 4
 9
 5 14
 15 2 15 2 15 2 15 2 15 2 15 2

 –10
 d40
 7
 d60 –10 7
 –10 7
 –10 7
 –10 7
 –10 7

 –10 –5 0 5 10 –10 –5 0 5 10 –10 –5 0 5 10 –10 –5 0 5 10 –10 –5 0 5 10 –10 –5 0 5 10
 UMAP_1 UMAP_1 UMAP_1 UMAP_1 UMAP_1 UMAP_1

 15 SLC34A2 LPCAT1 15
 SCGB3A2 CDX2 15 GATA4 15 THY1
 12 15 12
 12 15 12
 12 12

 10 10 10 10 10 10

 UMAP_2
 UMAP_2

 UMAP_2

 UMAP_2

 UMAP_2
 UMAP_2

 13 0 13 0 13 0 13 0
 5 6
 3 11
 5
 4 5 3
 13
 11
 0 5 5 6
 3 11
 5
 4 5 3
 13
 11
 0 5 5 6
 3 11
 5
 4
 5 6
 3 11
 5
 4
 8 1 6 8 1 4 8 1 6 8 1 4 8 1 8 1
 17 3 3 17 3 3 17 3 17 3
 0 10 2 0 10
 17
 2 0 10 2 0 10
 17
 2 0 10 2 0 10 2
 16 1 16 1 16 1 16 1 16 1 16 1

 –5 4
 9
 5 14 –5 4
 9
 5 14 –5 4
 9
 5 14 –5 4
 9
 5 14 –5 4
 9
 5 14 –5 4
 9
 5 14
 15 2 15 2 15 2 15 2 15 2 15 2

 –10 7
 –10 7
 –10 7
 –10 7
 –10 7
 –10 7

 –10 –5 0 5 10 –10 –5 0 5 10 –10 –5 0 5 10 –10 –5 0 5 10 –10 –5 0 5 10 –10 –5 0 5 10
 UMAP_1 UMAP_1 UMAP_1 UMAP_1 UMAP_1 UMAP_1

 15 COL1A2 ZEB1 15 TBX4 15 WNT2B 15 ACTA2 MKI67
 12 15 12
 12 12 12 15 12

 10 10 10 10 10 10
 UMAP_2

 UMAP_2

 UMAP_2

 UMAP_2
 UMAP_2

 UMAP_2
 13 0 13 0 13 0 13 0
 5 6
 3 11
 5
 4 5 3
 13
 11
 0 5 5 6
 3 11
 5
 4
 5 6
 3 11
 5
 4
 5 6
 3 11
 5
 4
 5 3
 13
 11
 0 5
 8 1 6 8 1 4 8 1 8 1 8 1 6 8 1 4
 17 3 3 17 3 17 3 17 3 3
 0 10 2 0 10
 17
 2 0 10 2 0 10 2 0 10 2 0 10
 17
 2
 16 1 16 1 16 1 16 1 16 1 16 1

 –5 4
 9
 5 14 –5 4
 9
 5 14 –5 4
 9
 5 14 –5 4
 9
 5 14 –5 4
 9
 5 14 –5 4
 9
 5 14
 15 2 15 2 15 2 15 2 15 2 15 2

 –10 7
 –10 7
 –10 7
 –10 7
 –10 7
 –10 7

 –10 –5 0 5 10 –10 –5 0 5 10 –10 –5 0 5 10 –10 –5 0 5 10 –10 –5 0 5 10 –10 –5 0 5 10
 UMAP_1 UMAP_1 UMAP_1 UMAP_1 UMAP_1 UMAP_1

 b
 d25
 12

 d80
 13 0
 3 11
 6 8 1
 17
 10
 16

 4
 5 14 d60
 9
 15 2
 7

 d40

d80, showing expression of each marker on top of each graph. Clusters corresponding to each timepoint are shown in the upper left plot. b, scVelo
trajectory analysis. Clusters are identiﬁed by colors. Pseudotime analysis was performed using scVelo on the merged datasets63,64.

 Gelatin
 Prepare a 0.1% (wt/vol) solution by dissolving gelatin in tissue culture grade water. Heat the gelatin
 solution to boiling for 5–10 min. After cooling down, ﬁlter the gelatin solution through a 0.22 μm
 ﬁlter to make it sterile. The gelatin solution can be kept at 4 °C for up to 3 months.
 Fibronectin
 Make 100 μl aliquots and store them at 4 °C for up to 6 months.
 L-Ascorbic acid
 Reconstitute at 50 mg/ml in sterile cell culture grade water (wt/vol). Filter the solution through a
 0.22 μm ﬁlter to make it sterile. Make 100 μl aliquots and store at −20 °C to −70 °C for up to
 3 months. ! CAUTION Discard unused solution. Always use a freshly thawed aliquot for culture.

 Media
 MEF medium
 Make 500 ml MEF medium by combining the reagents as detailed in the table below. Sterilize by
 ﬁltering through a 0.22 μm ﬁlter. MEF medium can be stored at 4 °C for up to 1 month.

 Reagent to add Stock concentration Volume to add Final concentration

 IMDM 415 ml
 Stem cell-qualiﬁed FBS 75 ml 15%
 MTG 11.5 M 20 μl 0.46 mM
 GlutaMAX 100× 5 ml 1×
 Penicillin–streptomycin 100× 5 ml 1×

 Box 3 scRNAseq | analysis
 For our scRNAseq analysis (see ‘Anticipated results’ and Figs. 7 and 8) libraries were prepared and sequenced at the JP Sulzberger Columbia
 Genome Center High-Throughput Screening Center at Columbia University. Sequencing libraries were prepared using 10x Genomics Single Cell
 Gene Expression 3′ workﬂow and sequenced on the Illumina NovaSeq 6000. FASTQ ﬁles were processed using cell ranger version 5.0.1 for each
 sample and the reads were aligned to the GRCh38 reference genome.
 Data were analyzed using the standardized Seurat pipeline V4 in R65 and reciprocal principal component analysis-based integration (https://satija
 lab.org/seurat/articles/integration_rpca.html). The steps involved in the analysis include: quality control analysis, normalization, integration of
 samples, dimensionality reduction, clustering and visualization of the data65. To begin, the Cell Ranger output count matrix was read into R and a
 Seurat object was created for each individual dataset. The four datasets were merged into one dataset and ﬁltered on the basis of the number of
 unique molecular identiﬁers (nUMI ≥500), number of genes (nGenes ≥250) and mitochondrial abundance (<20%) for further analysis. Following
 ﬁltering, the datasets were split and to account for batch effects, sequencing depth and to remove technical variability, normalization and variance
 stabilization was performed using the SCTransform (SCT) function in Seurat66. Cell cycle scoring and mitochondrial abundance was calculated and
 regressed out along with the normalization process using SCTransform.
 Integration is based identiﬁcation of common features in different datasets that serves as anchors across these datasets, such that batch effects
 are attenuated65. Merged analysis uses the processed data, but does correct those based on common anchors, and therefore does not correct for
 batch effects. However, as integration may be prone to overcorrection if differences in cellular composition between samples are large67, as may be
 these case in the organoids described here at different time points, we present both integrated (Fig. 7) and merged (Fig. 8) analyses. Features to
 use when integrating the datasets were chosen using SelectIntegrationFeatures function. Principal component analysis for each dataset was done
 individually before identifying integration anchors. We then set the normalization method to ‘SCT’ and the reduction to robust principal component
 analysis while using the FindIntegrationAnchors function. The datasets were integrated using the integration anchors identiﬁed using IntegrateData
 function. Principal component analysis was used to identify the number of dimensions (nDims) for dimensionality reduction of the integrated
 dataset and visualization was performed using RunPCA. nDims was used to compute the shared nearest neighbor graphs using the k-nearest
 neighbor algorithm, to ﬁnd relevant clusters and UMAP for visualization of the clusters was performed using RunUMAP function. Clusters were
 created with resolutions ranging from 0.4 to 0.8. We visualized and analyzed the different clusters on the basis of marker identiﬁcation using
 FeaturePlot and found 0.4 resolution to produce the most biologically informative clusters for our study. We performed pseudotime analysis using
 scVelo63 on the merged datasets.

 Stop medium
 Make 500 ml Stop medium by combining reagents as detailed in the table below. Sterilize by ﬁltering
 through a 0.22 μm ﬁlter. Stop medium can be stored at 4 °C for up to 1 month.

 Reagent to add Stock concentration Volume to add Final concentration

 IMDM 465 ml
 FBS 25 ml 5%
 GlutaMAX 100× 5 ml 1×
 Penicillin–streptomycin 100× 5 ml 1×

 hPSC maintenance medium
 Make 500 ml of hPSC maintenance medium by combining reagents as detailed in the table below.
 Sterilize by ﬁltering through a 0.22 μm ﬁlter. hPSC maintenance medium can be stored at 4 °C for up
 to 1 month. CRITICAL Supplement FGF2 to a ﬁnal concentration of 20 ng/ml right before use.
 c

 Reagent to add Stock concentration Volume to add Final concentration

 DMEM/F12 389 ml
 Knockout serum 100 ml 20%
 MEM-nonessential amino acids 5 ml
 β-Mercaptoethanol 14.3 M 3.5 μl 0.1 mM
 Primocin 50 mg/ml 1 ml 100 μg/ml
 GlutaMAX 5 ml
 Supplement with FGF2 before use
 FGF2 10 μg/ml 2 μl 20 ng/ml

 Serum-free differentiation (SFD) medium
 Make 1,000 ml of SFD medium by combining reagents as detailed in the table below. Sterilize by
 ﬁltering through a 0.22 μm ﬁlter. SFD medium can be store at 4 °C for up to 1 month. On the day of

PROTOCOL NATURE PROTOCOLS

 use, supplement SFD medium with L-ascorbic acid and MTG to a ﬁnal concentration of 50 μg/ml
 (1 μl/ml) and 0.45 mM (0.039 μl/ml), respectively, to make complete SFD medium.

 Reagent to add Stock concentration Volume to add Final concentration

 IMDM 725 ml
 Ham’s F12 242.5 ml
 N2 5 ml
 B27 10 ml
 7.5% BSA 7.5% 7.5 ml
 Penicillin–streptomycin 100× 10 ml 1×
 To make complete SFD medium, add the following to SFD
 Reagent to add Stock concentration Volume to add per ml Final concentration
 GlutaMAX 100× 10 μl 1×
 Ascorbic acid 50 mg/ml 1 μl 50 μg/ml
 MTG 11.5M 0.039 μl 0.45 mM

 EB/PS medium
 Make 12 ml of EB/PS medium, sufﬁcient for a six-well plate, by adding reagents as detailed in the

 Complete SFD medium supplemented with Stock concentration Volume to add per ml Final concentration

 Y-27632 10 mM 1 μl 10 μM
 BMP4 10 μg/ml 0.3 μl 3 ng/ml

 Endoderm induction medium
 Make 13 ml of endoderm induction medium, sufﬁcient for a six-well plate, by adding reagents as
 detailed in the table below to complete SFD medium. Prepare the medium fresh on the day of use.

 Complete SFD medium supplemented with Stock concentration Volume to add per ml Final concentration

 Y-27632 10 mM 1 μl 10 μM
 BMP4 10 μg/ml 0.05 μl 0.5 ng/ml
 FGF2 10 μg/ml 0.25 μl 2.5 ng/ml
 Activin A 100 μg/ml 1 μl 100 ng/ml

 Anteriorization medium-1
 Make 13 ml of anteriorization medium-1, sufﬁcient for a six-well plate, by adding reagents as detailed
 in the table below to complete SFD medium. Prepare the medium fresh on the day of use.

 Complete SFD medium supplemented with Stock concentration Volume to add per ml Final concentration

 Noggin 100 μg/ml 1 μl 100 ng/ml
 SB431542 10 mM 1 μl 10 μM

 Anteriorization medium-2
 Make 12 ml of anteriorization medium-2, sufﬁcient for a six-well plate, by supplementing reagents as
 detailed in the table below to complete SFD medium. Prepare the medium fresh on the day of use.

 Complete SFD medium supplemented with Stock concentration Volume to add per ml Final concentration

 SB431542 10 mM 1 μl 10 μM
 IWP2 1 mM 1 μl 1 μM

 Ventralization/branching medium
 Make 12 ml of ventralization/branching medium, sufﬁcient for a six-well plate, by adding reagents as
 detailed in the table below to complete SFD medium. The prepared medium can be stored at 4 °C up
 to 3 d.

 Complete SFD medium supplemented with Stock concentration Volume to add per ml Final concentration

 CHIR99021 3 mM 1 μl 3 μM
 FGF10 10 μg/ml 1 μl 10 ng/ml
 FGF7 (KGF) 10 μg/ml 1 μl 10 ng/ml
 BMP4 10 μg/ml 1 μl 10 ng/ml
 All-trans RA 0.5 mM 0.1 μl 50 nM

 Plating irradiated MEFs for hPSC culture
 Precoat six-well ﬂat bottom tissue culture-treated plates with 2 ml 0.1% gelatin made with cell culture
 grade water for 15 min at room temperature (20–25 oC). Thaw a frozen vial of pre-irradiated MEFs
 containing ~2 × 106 cells in a water bath at 37 °C. Add the thawed MEFs to 10 ml wash medium and
 centrifuge at 400g for 4 min. Aspirate the wash medium and add 1 ml of MEF medium. Count the
 MEFs and seed at a density of 17,000–25,000 cells/cm2 in 2 ml of MEF media in a normoxic incubator
 overnight. The irradiated MEFs should be plated 1 d before plating of hPSCs to allow attachment and
 spreading of the MEFs producing sufﬁcient extracellular matrix to prevent premature differentiation.

 hPSC culture
 Maintain hPSCs on irradiated MEFs. Culture cells in hPSC maintenance medium. Change medium
 daily. Passage hPSCs with Accutase/EDTA and replate at a dilution of 1:48. Maintain cultures in a
 humidiﬁed normoxic incubator. Further details covering how to properly maintain an hPSC culture
 can be found in ‘ES Cell International Pte Ltd: Methodology Manual Human Embryonic Stem Cell
 Culture 2005’ and ‘Harvard Stem Cell Institute (HSCI) StemBook Protocols for pluripotent cells, URL:
 http://www.stembook.org/protocols/pluripotent-cells’ and in our previously published protocols57,61.
 Lines are karyotyped and veriﬁed for mycoplasma contamination using PCR every 6 months.

 Thawing and aliquoting Matrigel
 Thaw growth factor-reduced Matrigel on ice at 4 °C overnight. For aliquots used for organoid embedding,
 prechill Posi-Click 1.7 ml microcentrifuge tubes on ice for 15 min and aliquot 0.5 ml of thawed Matrigel
 to each tube on ice. For aliquots used for coating of culture plates, prechill 15 ml conical tubes on ice for
 15 min and aliquot 1 ml of thawed Matrigel to each tube on ice. Aliquots can be stored at −20 °C for up
 to 6 months. CRITICAL Keep all parts contacting Matrigel cold to avoid polymerization.
 c

 Coating dishes with Matrigel for MEF depletion
 Thaw 1 ml Matrigel and add to 29 ml of cold IMDM to a 50 ml prechilled conical tube to obtain a ﬁnal
 concentration of 3.3% (vol/vol) and keep on ice. Make sure the diluted Matrigel is mixed well. Imme-
 diately transfer the 10 ml diluted Matrigel/IMDM solution to the 10 cm2 tissue culture dish. Matrigel-
 coated dishes can be used after 3 h of incubation at room temperature or stored at 4 °C for up to 2 weeks.
 Keep the dishes ﬂat in the refrigerator and avoid drying out of the Matrigel coating solution.

 Fibronectin plates
 Prepare ﬁbronectin-coated six-well plates by diluting ﬁbronectin to 4 μg/ml in DPBS. Add 2 ml ﬁbro-
 nectin/DPBS solution to each well and incubate the plates in a normoxic incubator for at least 30 min or
 4 °C overnight. Make sure the ﬁbronectin coating covers the entire plate (~12 ml of a six-well plate).
